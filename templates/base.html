{% load static %}
<!doctype html>
<html>
<head>
  <script>
    (function () {
      try {
        const stored = localStorage.getItem("theme");
        const prefersDark = window.matchMedia("(prefers-color-scheme: dark)").matches;
        const theme = stored ? stored : (prefersDark ? "dark" : "light");

        document.documentElement.setAttribute("data-theme", theme);
        if (theme === "dark") document.documentElement.classList.add("dark");
      } catch (_) {}
    })();
  </script>

  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Sprint Demo</title>

  <style>
    body{font-family:system-ui;margin:2rem}
    nav a, nav form{margin-right:1rem;display:inline-block}
    .btn{padding:.4rem .8rem;border:1px solid #888;border-radius:.5rem;background:#f8f8f8}

    /* dark-mode overrides */
    .dark body { background:#0b1020; color:#e5e7eb; }
    .dark a { color:#a78bfa; }
    .dark .btn {
      background:#1f2937;
      color:#e5e7eb;
      border-color:#374151;
    }
  </style>

  <link rel="stylesheet" href="{% static 'css/styles.css' %}?v=3">
</head>
<body>

  <nav class="navbar site-nav">
    <div class="container nav-inner">
      <div class="nav-left">
        <a class="navbar-brand" href="/">Class Demo</a>
      </div>

      <button id="nav-toggle" class="nav-toggle" aria-label="Toggle navigation" aria-expanded="false"> 
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M4 6h16M4 12h16M4 18h16" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
      </button>

      <div id="nav-links" class="nav-center">
        <ul class="nav-list">
        {% if user.is_authenticated %}
          <a class="nav-link d-inline-block" href="{% url 'accounts:profile' %}">Profile</a>
          <a class="nav-link d-inline-block" href="{% url 'accounts:profile_edit' %}">Edit Profile</a>
          <a class="nav-link d-inline-block" href="{% url 'accounts:notifications_feed' %}">Notifications</a>
          <a class="nav-link d-inline-block" href="{% url 'accounts:password_change' %}">Change Password</a>
          <a class="nav-link d-inline-block" href="{% url 'accounts:password_reset' %}">Forgot Password</a>
          <a class="nav-link d-inline-block" href="{% url 'accounts:delete_account' %}">Delete Account</a>
          <a class="nav-link d-inline-block" href="{% url 'accounts:contact_sponsor' %}">Contact Sponsor</a>
          <a class="nav-link d-inline-block" href="{% url 'faqs' %}">FAQs</a>
        {% if user.is_staff or user.is_superuser %}
          <a class="nav-link d-inline-block" href="/admin/">Admin Search</a>
          <a class="nav-link d-inline-block" href="/admin/create-driver/">Create Driver</a>
          <a class="nav-link d-inline-block" href="/admin/create-sponsor/">Create Sponsor</a>
          <a class="nav-link d-inline-block" href="{% url 'accounts:message_compose' %}">Send Messages</a>
          {% endif %}
        {% endif %}
        </ul>
      </div>

      <div class="nav-right">
        <div class="nav-actions">
        {% if user.is_authenticated %}
          <form method="post" action="{% url 'accounts:logout' %}" style="display:inline">
            {% csrf_token %}
            <button class="btn btn-muted" type="submit">Log Out</button>
          </form>
          <div id="idle-countdown" style="margin-left:.5rem;font-weight:600;color:var(--muted);"></div>
        {% else %}
          <a class="btn btn-muted" href="{% url 'accounts:login' %}">Login</a>
          <a class="btn btn-muted" href="{% url 'accounts:register' %}">Register</a>
        {% endif %}
        <button class="btn btn-muted" id="theme-toggle" type="button" aria-label="Toggle dark mode" aria-pressed="false">
          Dark Mode: Off
        </button>
        </div>
      </div>
    </div>
  </nav>

  
  <div class="container-main">
    {% block page_banner %}{% endblock page_banner %}
    {% for m in messages %}<p>{{ m }}</p>{% endfor %}
    {% block content %}{% endblock %}
  </div>

  
  <script>
    (function () {
      const btn = document.getElementById("theme-toggle");
      if (!btn) return;

      const setLabel = () => {
        const on = document.documentElement.classList.contains("dark");
        btn.textContent = "Dark Mode: " + (on ? "On" : "Off");
        btn.setAttribute("aria-pressed", String(on));
      };

      setLabel();

      btn.addEventListener("click", () => {
        const root = document.documentElement;
        root.classList.toggle("dark");
        const on = root.classList.contains("dark");
        try { localStorage.setItem("theme", on ? "dark" : "light"); } catch (_) {}
        setLabel();
      });
    })();
  </script>
  <script>
    // Inactivity logout:logout after 5 minutes
    (function () {
      // only run for users who are logged in
      try {
        const idleSeconds = 60 * 5; // 5 minutes
        let lastActivity = Date.now();
        let timeoutId = null;

        function getCookie(name) {
          const v = document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)');
          return v ? v.pop() : '';
        }

        function scheduleLogout() {
          clearTimeout(timeoutId);
          const ms = idleSeconds * 1000 - (Date.now() - lastActivity);
          if (ms <= 0) {
            doLogout();
          } else {
            timeoutId = setTimeout(doLogout, ms);
          }
        }

        function doLogout() {
          const csrftoken = getCookie('csrftoken');
          fetch("{% url 'accounts:logout' %}", {
            method: 'POST',
            headers: { 'X-CSRFToken': csrftoken, 'Content-Type': 'application/x-www-form-urlencoded' },
            body: ''
          }).catch(()=>{ /* ignore errors */ });
          // Also redirect to login page
          setTimeout(function(){ window.location = "{% url 'accounts:login' %}"; }, 200);
        }

        // reset activity on these events
        ['mousemove','mousedown','keydown','touchstart','scroll'].forEach(evt => {
          window.addEventListener(evt, function () { lastActivity = Date.now(); scheduleLogout(); }, { passive: true });
        });

        // UI countdown
        const countdownEl = document.getElementById('idle-countdown');
        function updateCountdown() {
          if (!countdownEl) return;
          const remaining = Math.max(0, idleSeconds - Math.round((Date.now() - lastActivity)/1000));
          const mm = String(Math.floor(remaining/60)).padStart(2,'0');
          const ss = String(remaining%60).padStart(2,'0');
          countdownEl.textContent = mm + ':' + ss;
        }

        // tick every second for the UI
        setInterval(updateCountdown, 1000);

        // start the timer
        scheduleLogout();
        updateCountdown();
      } catch (e) { /* ignore in older browsers */ }
    })();
  </script>
  <script>
    (function () {
      const navToggle = document.getElementById('nav-toggle');
      const siteNav = document.querySelector('.site-nav');
      if (!navToggle || !siteNav) return;

      navToggle.addEventListener('click', function () {
        const expanded = navToggle.getAttribute('aria-expanded') === 'true';
        navToggle.setAttribute('aria-expanded', String(!expanded));
        siteNav.classList.toggle('open');
      });
    })();
  </script>
</body>
</html>
