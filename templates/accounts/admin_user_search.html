{% extends "base.html" %}
{% block content %}
<h1>Admin: User & Sponsor Search</h1>

<form method="get" class="form-inline mb-3">
  <input type="hidden" name="q" value="{{ q }}">
  <input type="hidden" name="sponsor" value="{{ sponsor_q }}">
  <label>Export:</label>
  <select name="export_type">
    <option value="drivers">Drivers</option>
    <option value="sponsors">Sponsors</option>
    <option value="both">Both</option>
  </select>
  <input type="hidden" name="export" value="csv">
  <button class="btn">Export CSV</button>
</form>

<form method="get" class="form-inline mb-3">
  <div>
    <label>Driver search:</label>
    <input type="text" name="q" value="{{ q }}" placeholder="username, email, phone, address" />
    <button class="btn">Search Drivers</button>
  </div>
</form>

<form method="get" class="form-inline mb-3">
  <div>
    <label>Sponsor search:</label>
    <input type="text" name="sponsor" value="{{ sponsor_q }}" placeholder="sponsor name, email" />
    <button class="btn">Search Sponsors</button>
  </div>
</form>

{% if drivers %}
  <form method="get" class="form-inline mb-3">
    <input type="hidden" name="q" value="{{ q }}">
    <label for="sort">Sort by last login:</label>
    <select name="sort" id="sort" onchange="this.form.submit()">
      <option value="">--</option>
      <option value="last_login_desc" {% if request.GET.sort == "last_login_desc" %}selected{% endif %}>Most recent</option>
      <option value="last_login_asc" {% if request.GET.sort == "last_login_asc" %}selected{% endif %}>Oldest first</option>
    </select>

    <label for="inactive">Filter:</label>
    <select name="inactive" id="inactive" onchange="this.form.submit()">
      <option value="">All users</option>
      <option value="never" {% if request.GET.inactive == "never" %}selected{% endif %}>Never logged in</option>
      <option value="30days" {% if request.GET.inactive == "30days" %}selected{% endif %}>Inactive >30 days</option>
    </select>
  </form>

<form method="get" class="form-inline mb-3">
  <input type="hidden" name="q" value="{{ q }}">
  <input type="hidden" name="sponsor" value="{{ sponsor_q }}">
  <label>Export:</label>
  <select name="export_type">
    <option value="drivers">Drivers</option>
    <option value="sponsors">Sponsors</option>
    <option value="both">Both</option>
  </select>
  <input type="hidden" name="export" value="csv">
  <button class="btn">Export CSV</button>
</form>

  <h2>Drivers</h2>
  <p>Showing {{ drivers_matching_count }} matching drivers out of {{ total_drivers_count }} total drivers.</p>
  <table class="table">
    <thead>
      <tr>
        <th>Username</th>
        <th>Email</th>
        <th>Phone</th>
        <th>Address</th>
        <th>Last Login</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody>
      {% for u in drivers %}
      <tr {% if not u.is_active %}style="background-color: rgba(255, 100, 100, 0.08);" {% endif %}>
        <td>{{ u.username }}</td>
        <td>{{ u.email }}</td>
        <td>{{ u.driver_profile.phone }}</td>
        <td>{{ u.driver_profile.address }}</td>
        <td>
          {% if u.last_login %}
            {{ u.last_login|date:"Y-m-d H:i" }}<br>
            <small>{{ u.last_login|timesince }} ago</small>
          {% else %}
            <span style="color: red;">Never</span>
          {% endif %}
        </td>
        <td>
          <form method="post" action="{% url 'toggle_user_active' u.id %}" style="display:inline">
            {% csrf_token %}
            {% if u == request.user %}
              <!-- cannot change your own active status -->
              <button class="btn" disabled>Cannot change yourself</button>
            {% else %}
              {% if u.is_active %}
                <button class="btn btn-warning" type="submit">Deactivate</button>
              {% else %}
                <button class="btn btn-success" type="submit">Reactivate</button>
              {% endif %}
            {% endif %}
          </form>

          <!-- Temp Password Button -->
          <form method="post" action="{% url 'accounts:admin_set_temp_password' u.id %}" style="display:inline; margin-left: 5px;">
            {% csrf_token %}
            <button class="btn btn-secondary" type="submit">Temp Password</button>
          </form>

          <!-- Reset Link Button  -->
          <form method="post" action="{% url 'accounts:admin_send_reset_link' u.id %}" style="display:inline; margin-left: 5px;">
            {% csrf_token %}
            <button class="btn btn-info" type="submit">Send Reset Link</button>
          </form>

          <!-- Force logout Button  -->
          <form method="post" action="{% url 'accounts:admin_force_logout_user' u.id %}" style="display:inline; margin-left: 5px;">
            {% csrf_token %}
            <button class="btn btn-danger" type="submit" onclick="return confirm('Force logout this user?');">Force Logout</button>
          </form>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>

  <div>
    {% if drivers.has_previous %}
      <a href="?q={{ q }}&page={{ drivers.previous_page_number }}">Previous</a>
    {% endif %}
    Page {{ drivers.number }} of {{ drivers.paginator.num_pages }}
    {% if drivers.has_next %}
      <a href="?q={{ q }}&page={{ drivers.next_page_number }}">Next</a>
    {% endif %}
  </div>
{% endif %}

{% if sponsors %}
  <h2>Sponsors</h2>
  <p>Showing {{ sponsors_matching_count }} matching sponsors out of {{ total_sponsors_count }} total sponsors.</p>
  <table class="table">
    <thead><tr><th>Name</th><th>Order Count</th><th>Sample Drivers</th></tr></thead>
    <tbody>
      {% for s in sponsors %}
      <tr>
        <td>{{ s.name }}</td>
        <td>{{ s.count }}</td>
        <td>
          {% for d in s.drivers %}
            {{ d }}{% if not forloop.last %}, {% endif %}
          {% endfor %}
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
{% endif %}

{% if sponsor_users %}
  <h2>Sponsor Users</h2>
  <p>Showing {{ sponsor_users|length }} matching sponsor users.</p>
  <table class="table">
    <thead>
      <tr>
        <th>Username</th>
        <th>Email</th>
        <th>Status</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody>
      {% for s in sponsor_users %}
      <tr {% if not s.is_active %}style="background-color: rgba(255, 100, 100, 0.08);" {% endif %}>
        <td>{{ s.username }}</td>
        <td>{{ s.email }}</td>
        <td>
          {% if s.is_active %}
            <span style="color: lightgreen;">Active</span>
          {% else %}
            <span style="color: red;">Inactive</span>
          {% endif %}
        </td>
        <td>
          <form method="post" action="{% url 'toggle_user_active' s.id %}" style="display:inline">
            {% csrf_token %}
            {% if s == request.user %}
              <button class="btn" disabled>Cannot change yourself</button>
            {% else %}
              {% if s.is_active %}
                <button class="btn btn-warning" type="submit">Deactivate</button>
              {% else %}
                <button class="btn btn-success" type="submit">Reactivate</button>
              {% endif %}
            {% endif %}
          </form>
          <!-- Temp Password Button -->
          <form method="post" action="{% url 'accounts:admin_set_temp_password' s.id %}" style="display:inline; margin-left: 5px;">
            {% csrf_token %}
            <button class="btn btn-secondary" type="submit">Temp Password</button>
          </form>

          <!-- Reset Link Button -->
          <form method="post" action="{% url 'accounts:admin_send_reset_link' s.id %}" style="display:inline; margin-left: 5px;">
            {% csrf_token %}
            <button class="btn btn-info" type="submit">Send Reset Link</button>
          </form>
          <!-- Force logout Button  -->
          <form method="post" action="{% url 'accounts:admin_force_logout_user' s.id %}" style="display:inline; margin-left: 5px;">
            {% csrf_token %}
            <button class="btn btn-danger" type="submit" onclick="return confirm('Force logout this user?');">Force Logout</button>
          </form>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
{% endif %}

{% endblock content %}
