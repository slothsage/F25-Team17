{% extends "base.html" %}
{% block title %}Dashboard{% endblock title %}

{% block content %}
<h1>My Dashboard</h1>
<p class="text-muted">Drag and drop widgets to rearrange them. Your preferences will be saved automatically.</p>

<div id="dashboard-widgets" class="dashboard-container">
  {% for widget_id in widget_order %}
    {% if widget_id == 'points' %}
      <!-- Points Widget -->
      <div class="dashboard-widget" data-widget-id="points" draggable="true">
        <div class="widget-header">
          <h3><i class="fas fa-star"></i> Points</h3>
          <span class="drag-handle" title="Drag to reorder"><i class="fas fa-grip-vertical"></i></span>
        </div>
        <div class="widget-body">
          <div class="points-summary">
            <div class="d-flex align-items-center gap-3 mb-3">
              <div class="points-circle text-white">
                <i class="fas fa-star"></i>
              </div>
              <div>
                <p class="text-uppercase text-muted mb-1 small">Total Points</p>
                <p class="h2 mb-0 fw-bold">{{ total_points|default:0 }} <span class="fs-6 text-muted">pts</span></p>
              </div>
            </div>
            
            {% if has_goal %}
              <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #dee2e6;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                  <span style="font-weight: 600; font-size: 0.9rem;">Goal: {{ points_goal|floatformat:0 }} points</span>
                  <span style="font-weight: 600; color: #007bff; font-size: 0.9rem;">{{ progress_percentage }}%</span>
                </div>
                <div style="background: #e9ecef; border-radius: 0.5rem; height: 1.5rem; position: relative; overflow: hidden; border: 1px solid #dee2e6;">
                  <div style="
                    background: {% if progress_percentage >= 100 %}linear-gradient(90deg, #28a745 0%, #20c997 100%);
                    {% elif progress_percentage >= 75 %}linear-gradient(90deg, #007bff 0%, #0056b3 100%);
                    {% elif progress_percentage >= 50 %}linear-gradient(90deg, #17a2b8 0%, #138496 100%);
                    {% elif progress_percentage >= 25 %}linear-gradient(90deg, #ffc107 0%, #e0a800 100%);
                    {% else %}linear-gradient(90deg, #dc3545 0%, #c82333 100%);{% endif %}
                    height: 100%;
                    width: {{ progress_percentage }}%;
                    transition: width 0.3s ease;
                    border-radius: 0.5rem;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    color: white;
                    font-weight: bold;
                    font-size: 0.75rem;
                  ">
                    {% if progress_percentage > 15 %}{{ progress_percentage }}%{% endif %}
                  </div>
                </div>
                {% if progress_percentage >= 100 %}
                  <p style="margin-top: 0.5rem; margin-bottom: 0; color: #28a745; font-weight: 600; font-size: 0.9rem;">
                    ðŸŽ‰ Goal achieved!
                  </p>
                {% else %}
                  <p style="margin-top: 0.5rem; margin-bottom: 0; color: #6c757d; font-size: 0.85rem;">
                    {{ points_remaining|floatformat:0 }} points remaining
                  </p>
                {% endif %}
              </div>
            {% endif %}
            
            <div class="mt-3 d-flex gap-2 flex-wrap">
              <a class="btn btn-outline-primary btn-sm" href="{% url 'accounts:points_history' %}">
                View History
              </a>
              <a class="btn btn-primary btn-sm" href="{% url 'accounts:points_goal_tracker' %}">
                {% if has_goal %}Update Goal{% else %}Set Goal{% endif %}
              </a>
            </div>
          </div>
        </div>
      </div>
    
    {% elif widget_id == 'orders' %}
      <!-- Orders Widget -->
      <div class="dashboard-widget" data-widget-id="orders" draggable="true">
        <div class="widget-header">
          <h3><i class="fas fa-shopping-bag"></i> Recent Orders</h3>
          <span class="drag-handle" title="Drag to reorder"><i class="fas fa-grip-vertical"></i></span>
        </div>
        <div class="widget-body">
          {% if recent_orders %}
            <ul class="list-unstyled mb-0">
              {% for order in recent_orders %}
                <li class="mb-2 pb-2 border-bottom">
                  <div class="d-flex justify-content-between align-items-start">
                    <div>
                      <a href="{% url 'shop:order_detail' order.id %}" class="text-decoration-none">
                        <strong>Order #{{ order.id }}</strong>
                      </a>
                      <div class="small text-muted">
                        {{ order.placed_at|date:"M d, Y" }}
                      </div>
                    </div>
                    <div class="text-end">
                      <span class="badge bg-{% if order.status == 'delivered' %}success{% elif order.status == 'cancelled' %}danger{% elif order.status == 'shipped' %}info{% else %}warning{% endif %}">
                        {{ order.get_status_display }}
                      </span>
                      <div class="small text-muted mt-1">
                        {{ order.points_spent }} pts
                      </div>
                    </div>
                  </div>
                </li>
              {% endfor %}
            </ul>
            <div class="mt-3">
              <a class="btn btn-outline-primary btn-sm w-100" href="{% url 'shop:order_list' %}">
                View All Orders
              </a>
            </div>
          {% else %}
            <p class="text-muted mb-0">No orders yet.</p>
            <div class="mt-3">
              <a class="btn btn-primary btn-sm" href="{% url 'shop:catalog_search' %}">
                Start Shopping
              </a>
            </div>
          {% endif %}
        </div>
      </div>
    
    {% elif widget_id == 'wishlist' %}
      <!-- Wishlist Widget -->
      <div class="dashboard-widget" data-widget-id="wishlist" draggable="true">
        <div class="widget-header">
          <h3><i class="fas fa-heart"></i> Wishlists</h3>
          <span class="drag-handle" title="Drag to reorder"><i class="fas fa-grip-vertical"></i></span>
        </div>
        <div class="widget-body">
          {% if wishlists %}
            <ul class="list-unstyled mb-0">
              {% for wishlist in wishlists %}
                <li class="mb-2 pb-2 border-bottom">
                  <div class="d-flex justify-content-between align-items-start">
                    <div>
                      <strong>{{ wishlist.name }}</strong>
                      <div class="small text-muted">
                        {{ wishlist.item_count }} item{{ wishlist.item_count|pluralize }}
                      </div>
                    </div>
                    <div class="small text-muted">
                      Updated {{ wishlist.updated_at|date:"M d" }}
                    </div>
                  </div>
                </li>
              {% endfor %}
            </ul>
            <div class="mt-3">
              <a class="btn btn-outline-primary btn-sm w-100" href="{% url 'shop:wishlist_list' %}">
                Manage Wishlists
              </a>
            </div>
          {% else %}
            <p class="text-muted mb-0">No wishlists yet.</p>
            <div class="mt-3">
              <a class="btn btn-primary btn-sm" href="{% url 'shop:catalog_search' %}">
                Browse Catalog
              </a>
            </div>
          {% endif %}
        </div>
      </div>
    
    {% elif widget_id == 'catalog' %}
      <!-- Catalog Widget -->
      <div class="dashboard-widget" data-widget-id="catalog" draggable="true">
        <div class="widget-header">
          <h3><i class="fas fa-store"></i> Browse Catalog</h3>
          <span class="drag-handle" title="Drag to reorder"><i class="fas fa-grip-vertical"></i></span>
        </div>
        <div class="widget-body">
          <div class="mb-3">
            <p class="text-muted mb-2">
              <i class="fas fa-box"></i> {{ catalog_item_count }} item{{ catalog_item_count|pluralize }} available
            </p>
            <p class="small text-muted mb-3">
              Search and browse products from your sponsors' catalogs and eBay.
            </p>
          </div>
          
          <!-- Quick Search Form -->
          <form method="get" action="{% url 'shop:catalog_search' %}" class="mb-3">
            <div class="input-group">
              <input 
                type="text" 
                name="q" 
                class="form-control form-control-sm" 
                placeholder="Search products..."
                autocomplete="off"
              >
              <button class="btn btn-primary btn-sm" type="submit">
                <i class="fas fa-search"></i>
              </button>
            </div>
          </form>
          
          <div class="d-grid gap-2">
            <a class="btn btn-primary btn-sm" href="{% url 'shop:catalog_search' %}">
              <i class="fas fa-store"></i> Browse Full Catalog
            </a>
            <a class="btn btn-outline-secondary btn-sm" href="{% url 'shop:cart' %}">
              <i class="fas fa-shopping-cart"></i> View Cart
            </a>
          </div>
        </div>
      </div>
    {% endif %}
  {% endfor %}
</div>

<style>
.dashboard-container {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
  gap: 1.5rem;
  margin-top: 1.5rem;
}

.dashboard-widget {
  background: white;
  border: 1px solid #dee2e6;
  border-radius: 8px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  transition: transform 0.2s, box-shadow 0.2s;
  cursor: move;
}

.dashboard-widget:hover {
  box-shadow: 0 4px 8px rgba(0,0,0,0.15);
}

.dashboard-widget.dragging {
  opacity: 0.5;
  transform: scale(0.95);
}

.dashboard-widget.drag-over {
  border-color: #007bff;
  box-shadow: 0 0 0 3px rgba(0,123,255,0.25);
}

.widget-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 1rem;
  border-bottom: 1px solid #dee2e6;
  background: #f8f9fa;
  border-radius: 8px 8px 0 0;
}

.widget-header h3 {
  margin: 0;
  font-size: 1.1rem;
  font-weight: 600;
  color: #333;
}

.drag-handle {
  color: #6c757d;
  cursor: grab;
  padding: 0.25rem;
}

.drag-handle:active {
  cursor: grabbing;
}

.widget-body {
  padding: 1rem;
}

.points-circle {
  width: 64px;
  height: 64px;
  border-radius: 50%;
  background: #0d6efd;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.5rem;
  box-shadow: inset 0 0 10px rgba(255,255,255,0.25);
}

@media (max-width: 768px) {
  .dashboard-container {
    grid-template-columns: 1fr;
  }
}
</style>

<script>
(function() {
  const container = document.getElementById('dashboard-widgets');
  const widgets = container.querySelectorAll('.dashboard-widget');
  let draggedElement = null;
  let draggedIndex = null;
  
  // Add drag event listeners to all widgets
  widgets.forEach((widget, index) => {
    widget.addEventListener('dragstart', (e) => {
      draggedElement = widget;
      draggedIndex = index;
      widget.classList.add('dragging');
      e.dataTransfer.effectAllowed = 'move';
      e.dataTransfer.setData('text/html', widget.innerHTML);
    });
    
    widget.addEventListener('dragend', (e) => {
      widget.classList.remove('dragging');
      widgets.forEach(w => w.classList.remove('drag-over'));
    });
    
    widget.addEventListener('dragover', (e) => {
      e.preventDefault();
      e.dataTransfer.dropEffect = 'move';
      
      const afterElement = getDragAfterElement(container, e.clientY);
      const dragging = document.querySelector('.dragging');
      
      if (afterElement == null) {
        container.appendChild(dragging);
      } else {
        container.insertBefore(dragging, afterElement);
      }
    });
    
    widget.addEventListener('dragenter', (e) => {
      e.preventDefault();
      if (widget !== draggedElement) {
        widget.classList.add('drag-over');
      }
    });
    
    widget.addEventListener('dragleave', (e) => {
      widget.classList.remove('drag-over');
    });
    
    widget.addEventListener('drop', (e) => {
      e.preventDefault();
      widget.classList.remove('drag-over');
    });
  });
  
  function getDragAfterElement(container, y) {
    const draggableElements = [...container.querySelectorAll('.dashboard-widget:not(.dragging)')];
    
    return draggableElements.reduce((closest, child) => {
      const box = child.getBoundingClientRect();
      const offset = y - box.top - box.height / 2;
      
      if (offset < 0 && offset > closest.offset) {
        return { offset: offset, element: child };
      } else {
        return closest;
      }
    }, { offset: Number.NEGATIVE_INFINITY }).element;
  }
  
  // Save widget order when drag ends
  container.addEventListener('dragend', () => {
    const newOrder = Array.from(container.querySelectorAll('.dashboard-widget')).map(w => w.dataset.widgetId);
    saveWidgetOrder(newOrder);
  });
  
  function saveWidgetOrder(order) {
    fetch('{% url "accounts:save_widget_order" %}', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCookie('csrftoken')
      },
      body: JSON.stringify({ widget_order: order })
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        // Optional: Show a brief success message
        const message = document.createElement('div');
        message.className = 'alert alert-success alert-dismissible fade show';
        message.style.position = 'fixed';
        message.style.top = '20px';
        message.style.right = '20px';
        message.style.zIndex = '9999';
        message.innerHTML = '<i class="fas fa-check"></i> Widget order saved!';
        document.body.appendChild(message);
        setTimeout(() => {
          message.remove();
        }, 2000);
      }
    })
    .catch(error => {
      console.error('Error saving widget order:', error);
    });
  }
  
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }
})();
</script>
{% endblock content %}

