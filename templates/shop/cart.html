{% extends "base.html" %}{% block content %}
<h1>My Cart</h1>

<h2>Delivery Address</h2>
<p>Current: {{ profile.address|default:"(not set)" }}</p>

<form method="post" action="{% url 'shop:cart' %}" style="margin:.5rem 0 1rem;">
  {% csrf_token %}
  <input type="hidden" name="action" value="update_address">
  {{ address_form.as_p }}   {# TEMP: render entire form to prove it's there #}
  <button class="btn" type="submit">Save Address</button>
</form>
<hr/>

{% if items %}
  <ul>
  {% for it in items %}
    <li>{{ it.name_snapshot }} — {{ it.quantity }} × {{ it.points_each }} pts</li>
  {% endfor %}
  </ul>
  
  <!-- Points Summary -->
  <div style="background: #f8f9fa; padding: 1rem; border-radius: 0.5rem; margin: 1rem 0; border: 1px solid #dee2e6;">
    <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
      <span>Available Points:</span>
      <strong style="color: #007bff;">{{ total_balance|default:0 }} pts</strong>
    </div>
    <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
      <span>Cart Total:</span>
      <strong>{{ total_points }} pts</strong>
    </div>
    <hr style="margin: 0.75rem 0;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
      <span><strong>Remaining Points After Purchase:</strong></span>
      <strong style="font-size: 1.1rem; color: {% if remaining_points >= 0 %}#28a745{% else %}#dc3545{% endif %};">
        {{ remaining_points|default:0 }} pts
      </strong>
    </div>
    <div style="text-align: right; color: #6c757d; font-size: 0.85rem;">
      {{ total_balance|default:0 }} - {{ total_points }} = {{ remaining_points|default:0 }}
    </div>
  </div>

  <div class="d-flex gap-2 flex-wrap align-items-center" style="margin-top: 1rem;">
    <form method="post" action="{% url 'shop:save_cart_for_later' %}" style="display: inline-block;">
      {% csrf_token %}
      <div class="d-flex gap-2 align-items-center">
        <input type="text" 
               name="cart_name" 
               placeholder="Cart name (optional)" 
               class="form-control" 
               style="max-width: 200px; display: inline-block;"
               maxlength="200">
        <button type="submit" class="btn btn-outline-primary">
          <i class="fas fa-bookmark"></i> Save for Later
        </button>
      </div>
    </form>
    
    <form method="post" action="{% url 'shop:clear_cart' %}" style="display: inline-block;">
      {% csrf_token %}
      <button class="btn btn-outline-secondary" onclick="return confirm('Clear all items?')">
        <i class="fas fa-trash"></i> Clear Cart
      </button>
    </form>
    
    <a href="{% url 'shop:checkout' %}" class="btn" style="background:#16a34a;color:#fff;">
      <i class="fas fa-shopping-cart"></i> Proceed to Checkout
    </a>
  </div>
  
  <div style="margin-top: 1rem;">
    <a href="{% url 'shop:saved_carts' %}" class="btn btn-outline-info">
      <i class="fas fa-bookmark"></i> View Saved Carts
    </a>
  </div>
{% else %}
  <div class="alert alert-info">
    <i class="fas fa-info-circle me-2"></i>Your cart is empty.
    <a href="{% url 'shop:saved_carts' %}" class="alert-link">View your saved carts</a> to restore items.
  </div>
{% endif %}

{% endblock %}