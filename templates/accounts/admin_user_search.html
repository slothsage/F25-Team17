{% extends "base.html" %}
{% load i18n %}

{% block content %}
                
                <div class="container-main">
                  <header class="toolbar">
                    <div class="toolbar-left">
                      <h1 class="page-title">Admin: User, Sponsor &amp; Admin Search</h1>
                      <p class="page-subtitle">Find drivers, sponsors, and admin users, manage accounts, and export CSVs.</p>
                    </div>
                    <div class="toolbar-right" style="display: flex; flex-wrap: wrap; gap: 0.5rem; align-items: center;">
                      <a class="btn btn-muted" href="{% url 'accounts:login_activity' %}">View Login Activity</a>
                      <a class="btn btn-primary" href="{% url 'accounts:admin_active_sessions' %}">Active Sessions</a>
                      <a class="btn btn-warning" href="{% url 'accounts:archived_sponsors' %}">Archived Sponsors</a>
                      <!-- Error Log Download (with Date Filter) -->
                      <form method="get" action="{% url 'accounts:download_error_log' %}" style="display: flex; align-items: center; gap: 0.25rem; margin: 0;">
                        <input type="date" name="date" class="input" style="height: 38px; padding: 0.4rem 0.8rem; border: 1px solid #888; border-radius: 0.5rem;">
                        <button class="btn btn-danger" type="submit">Download Logs</button>
                      </form>

                      <!-- Bulk Upload CSV -->
                      <a class="btn btn-success" href="{% url 'accounts:bulk_upload_users' %}">Bulk Upload CSV</a>
                      <!-- Bulk assign to sponsor -->
                      <a class="btn btn-info" href="{% url 'accounts:bulk_assign_sponsorship' %}">
                        Bulk Assign Sponsors
                      </a>
                    </div>

                    <!-- Label Filter -->
                    <div class="toolbar mt-3" style="display:flex; justify-content:flex-end; gap:10px;">
                      <form method="get" class="d-flex align-items-center">
                        <label for="label-filter" class="me-2 fw-semibold">Filter by Label:</label>
                        <select id="label-filter" name="label" class="form-select form-select-sm" style="width:auto;" onchange="this.form.submit()">
                          <option value="">-- All --</option>
                          {% for label in labels %}
                            <option value="{{ label.name }}" {% if label.name == selected_label %}selected{% endif %}>
                              {{ label.name }}
                            </option>
                          {% endfor %}
                        </select>
                        {% if selected_label %}
                          <a href="?" class="btn btn-sm btn-link text-danger ms-2">Clear</a>
                        {% endif %}
                      </form>
                    </div>

                    <!-- Label Management -->
                    <div class="toolbar mt-3" style="display: flex; justify-content: flex-end; gap: 10px;">
                      <a href="{% url 'accounts:manage_labels' %}" class="btn btn-outline-primary">
                          Manage Labels
                      </a>
                      <a href="{% url 'accounts:assign_labels' %}" class="btn btn-outline-success">
                          Assign Labels
                      </a>
                    </div>

                    

                  </header>

                  <!-- Search Cards -->
                  <section class="grid search-grid center-narrow">
                    <!-- DRIVER SEARCH -->
                    <article class="card">
                      <div class="card-header"><h2 class="card-title">Driver search</h2></div>
                      <div class="card-body">
                        <form method="get" class="stack gap-sm">
                          <div class="autocomplete" data-limit="6" data-endpoint="{% url 'accounts:api_driver_suggest' %}">
                            <input
                              name="q"
                              value="{{ q }}"
                              class="input ac-input"
                              placeholder="username, email, phone, address or id:123"
                              autocomplete="off"
                              aria-label="Search drivers"
                            />
                            <div class="ac-panel" role="listbox" hidden></div>
                          </div>
                          <div class="row-actions">
                            <button class="btn btn-primary">Search Drivers</button>
                          </div>
                        </form>
                      </div>
                    </article>

                    <!-- SPONSOR SEARCH -->
                    <article class="card">
                      <div class="card-header"><h2 class="card-title">Sponsor search</h2></div>
                      <div class="card-body">
                        <form method="get" class="stack gap-sm">
                          <div class="autocomplete" data-limit="6" data-endpoint="{% url 'accounts:api_sponsor_suggest' %}">
                            <input
                              name="sponsor"
                              value="{{ sponsor_q }}"
                              class="input ac-input"
                              placeholder="sponsor name, email"
                              autocomplete="off"
                              aria-label="Search sponsors"
                            />
                            <div class="ac-panel" role="listbox" hidden></div>
                          </div>
                          <div class="row-actions">
                            <button class="btn btn-primary">Search Sponsors</button>
                          </div>
                        </form>
                      </div>
                    </article>

                    <!-- ADMIN SEARCH -->
                    <article class="card">
                      <div class="card-header"><h2 class="card-title">Admin search</h2></div>
                      <div class="card-body">
                        <form method="get" class="stack gap-sm">
                          <input
                            name="admin"
                            value="{{ admin_q }}"
                            class="input"
                            placeholder="admin username, email, first name, last name"
                            autocomplete="off"
                            aria-label="Search admin users"
                          />
                          <div class="row-actions">
                            <button class="btn btn-primary">Search Admins</button>
                          </div>
                        </form>
                      </div>
                    </article>

                    <!-- EXPORT -->
                    <article class="card">
                      <div class="card-header"><h2 class="card-title">Export</h2></div>
                      <div class="card-body">
                        <div class="row-actions">
                          <form method="get" class="inline">
                            <input type="hidden" name="q" value="{{ q }}" />
                            <input type="hidden" name="sponsor" value="{{ sponsor_q }}" />
                            <input type="hidden" name="export" value="csv" />
                            <input type="hidden" name="export_type" value="drivers" />
                            <button class="btn btn-muted">Export Drivers</button>
                          </form>
                          <form method="get" class="inline">
                            <input type="hidden" name="q" value="{{ q }}" />
                            <input type="hidden" name="sponsor" value="{{ sponsor_q }}" />
                            <input type="hidden" name="export" value="csv" />
                            <input type="hidden" name="export_type" value="sponsors" />
                            <button class="btn btn-muted">Export Sponsors</button>
                          </form>
                        </div>
                      </div>
                    </article>
                  </section>

                  <!-- DRIVERS RESULT TABLE -->
                  <section class="card mt-lg">
                    <div class="card-header">
                      <div class="card-title-row">
                        <h2 class="card-title">Drivers</h2>
                        <div class="pill muted">Showing {{ drivers_matching_count }} / {{ total_drivers_count }}</div>
                      </div>
                    </div>
                    <div class="card-body">
                      <div class="table-wrap">
                        <table class="table table-admin">
                          <thead>
                            <tr>
                              <th class="col-id">ID</th>
                              <th>Username</th>
                              <th>Email</th>
                              <th>Phone</th>
                              <th>Address</th>
                              <th>Labels</th>
                              <th>
                                {% with current_q=request.GET.q|default:"" current_label=request.GET.label|default:"" %}
                                  {% if request.GET.sort == "sponsor_asc" %}
                                    <a href="?q={{ current_q }}&label={{ current_label }}&sort=sponsor_desc" class="link-muted">Sponsor â–¼</a>
                                  {% elif request.GET.sort == "sponsor_desc" %}
                                    <a href="?q={{ current_q }}&label={{ current_label }}&sort=sponsor_asc" class="link-muted">Sponsor â–²</a>
                                  {% else %}
                                    <a href="?q={{ current_q }}&label={{ current_label }}&sort=sponsor_asc" class="link-muted">Sponsor</a>
                                  {% endif %}
                                {% endwith %}
                              </th>
                              <th>Last Login</th>
                              <th class="col-actions">Actions</th>
                            </tr>
                          </thead>
                          <tbody>
                            {% for u in drivers %}
                            <tr
                              {% if not u.is_active %}
                                style="background-color: rgba(255, 100, 100, 0.08);"
                              {% elif u.driver_profile.is_locked %}
                                style="background-color: rgba(255, 0, 0, 0.15);"
                              {% elif u.driver_profile.is_suspended %}
                                style="background-color: rgba(255, 200, 0, 0.15);"
                              {% endif %}
                            >
                              <td class="mono">{{ u.id }}</td>
                              <td class="wrap">{{ u.username }}</td>
                              <td class="wrap">{{ u.email }}</td>
                              <td class="wrap">{{ u.driver_profile.phone }}</td>
                              <td class="wrap">{{ u.driver_profile.address }}</td>
                              <!-- Labels -->
                              <td>
                                {% for label in u.driver_profile.labels.all %}
                                  <span class="badge" style="background-color: {{ label.color }}; color: #fff;">
                                    {{ label.name }}
                                  </span>
                                {% empty %}
                                  <span class="text-muted">â€”</span>
                                {% endfor %}
                              </td>
                              <!-- New Sponsor Column -->
                              <td class="wrap">
                                {% if u.driver_profile.sponsor_name %}
                                  <span class="badge info">{{ u.driver_profile.sponsor_name }}</span><br>
                                  <small class="subtle">{{ u.driver_profile.sponsor_email }}</small>
                                {% else %}
                                  <span class="muted">No Sponsor</span>
                                {% endif %}
                              </td>

                              <!-- Last Login -->
                              <td class="nowrap">
                                {% if u.last_login %}
                                  {{ u.last_login|date:"Y-m-d H:i" }}<br>
                                  <small class="subtle">{{ u.last_login|timesince }} ago</small>
                                {% else %}
                                  <span class="badge danger">Never</span>
                                {% endif %}
                              </td>
                              <td class="actions">
                                <!-- View As Driver (Impersonation) -->
                                <form method="post" action="{% url 'accounts:view_as_driver' u.id %}" class="inline">
                                  {% csrf_token %}
                                  <button class="btn btn-info" type="submit" style="background:#7048e8;border-color:#7048e8;" onclick="return confirm('View the site as {{ u.username }}? You will be able to see exactly what they see.');">
                                    View As Driver
                                  </button>
                                </form>

                                <!-- Edit Profile -->
                                <a class="btn btn-primary" href="{% url 'accounts:admin_profile_edit' u.id %}">Edit Profile</a>

                                <!-- Transfer Sponsor -->
                                <a class="btn btn-outline-info" href="{% url 'accounts:transfer_driver_sponsor' u.id %}">
                                  Transfer Sponsor
                                </a>

                                <!-- Active toggle -->
                                <form method="post" action="{% url 'accounts:toggle_user_active' u.id %}" class="inline">
                                  {% csrf_token %}
                                  {% if u == request.user %}
                                    <button class="btn" disabled>Cannot change yourself</button>
                                  {% else %}
                                    {% if u.is_active %}
                                      <button class="btn btn-warning" type="submit">Deactivate</button>
                                    {% else %}
                                      <button class="btn btn-success" type="submit">Reactivate</button>
                                    {% endif %}
                                  {% endif %}
                                </form>

                                <!-- Temp password -->
                                <form method="post" action="{% url 'accounts:admin_set_temp_password' u.id %}" class="inline">
                                  {% csrf_token %}
                                  <button class="btn btn-secondary" type="submit">Temp Password</button>
                                </form>

                                <!-- Change password page -->
                                <a class="btn btn-primary" href="{% url 'accounts:admin_set_password' u.id %}">Change Password</a>

                                <!-- Send reset link -->
                                <form method="post" action="{% url 'accounts:admin_send_reset_link' u.id %}" class="inline">
                                  {% csrf_token %}
                                  <button class="btn btn-info" type="submit">Send Reset Link</button>
                                </form>

                                <!-- Force logout -->
                                <form method="post" action="{% url 'accounts:admin_force_logout_user' u.id %}" class="inline">
                                  {% csrf_token %}
                                  <button class="btn btn-danger" type="submit" onclick="return confirm('Force logout this user?');">Force Logout</button>
                                </form>

                                <!-- Lock/Unlock -->
                                <form method="post" action="{% url 'accounts:toggle_lock_user' u.id %}" class="inline">
                                  {% csrf_token %}
                                  {% if u.driver_profile.is_locked %}
                                    <button class="btn btn-success" type="submit" onclick="return confirm('Unlock this user?');">Unlock</button>
                                  {% else %}
                                    <button class="btn btn-dark" type="submit" onclick="return confirm('Lock this user?');">Lock</button>
                                  {% endif %}
                                </form>

                                <!-- Suspend -->
                                <form method="post" action="{% url 'accounts:toggle_suspend_user' u.id %}" style="display:inline; margin-left: 5px;">
                                  {% csrf_token %}
                                  {% if u.driver_profile.is_suspended %}
                                    <button class="btn btn-secondary" type="submit" onclick="return confirm('Unsuspend this user?');">Unsuspend</button>
                                  {% else %}
                                    <button class="btn btn-dark" type="submit" onclick="return confirm('Suspend this user?');">Suspend</button>
                                  {% endif %}
                                </form>

                                <!-- Session timeout -->
                                <a class="btn btn-secondary" href="{% url 'accounts:admin_set_timeout' u.id %}">Set Timeout</a>
                              </td>
                            </tr>
                            {% empty %}
                            <tr>
                              <td colspan="7" class="muted">No drivers found.</td>
                            </tr>
                            {% endfor %}
                          </tbody>
                        </table>
                      </div>

                      <nav class="pagination">
                        {% if drivers.has_previous %}
                          <a class="page-link" href="?q={{ q }}&page={{ drivers.previous_page_number }}{% if request.GET.sort %}&sort={{ request.GET.sort }}{% endif %}{% if request.GET.inactive %}&inactive={{ request.GET.inactive }}{% endif %}">Previous</a>
                        {% endif %}
                        <span class="page-status">Page {{ drivers.number }} of {{ drivers.paginator.num_pages }}</span>
                        {% if drivers.has_next %}
                          <a class="page-link" href="?q={{ q }}&page={{ drivers.next_page_number }}{% if request.GET.sort %}&sort={{ request.GET.sort }}{% endif %}{% if request.GET.inactive %}&inactive={{ request.GET.inactive }}{% endif %}">Next</a>
                        {% endif %}
                      </nav>
                    </div>
                  </section>

                  {% if sponsors %}
                  <section class="card mt-lg">
                    <div class="card-header">
                      <div class="card-title-row">
                        <h2 class="card-title">Sponsors</h2>
                        <div class="pill muted">Showing {{ sponsors_matching_count }} / {{ total_sponsors_count }}</div>
                      </div>
                    </div>
                    <div class="card-body">
                      <div class="table-wrap">
                        <table class="table table-admin">
                          <thead>
                            <tr>
                              <th>Name</th>
                              <th>Order Count</th>
                              <th>Sample Drivers</th>
                            </tr>
                          </thead>
                          <tbody>
                            {% for s in sponsors %}
                            <tr>
                              <td class="wrap">{{ s.name }}</td>
                              <td class="mono">{{ s.count }}</td>
                              <td class="wrap">
                                {% for d in s.drivers %}
                                  <span class="chip">{{ d }}</span>
                                {% endfor %}
                              </td>
                            </tr>
                            {% endfor %}
                          </tbody>
                        </table>
                      </div>

                      <form method="get" class="inline">
                        <input type="hidden" name="q" value="{{ q }}">
                        <input type="hidden" name="sponsor" value="{{ sponsor_q }}">
                        <input type="hidden" name="export" value="csv">
                        <input type="hidden" name="export_type" value="sponsors">
                        <button class="btn btn-muted">Export Sponsors</button>
                      </form>
                    </div>
                  </section>
                  {% endif %}

                  {% if sponsor_users %}
                  <section class="card mt-lg">
                    <div class="card-header">
                      <div class="card-title-row">
                        <h2 class="card-title">Sponsor Users</h2>
                        <div class="pill muted">Showing {{ sponsor_users|length }}</div>
                      </div>
                    </div>
                    <div class="card-body">
                      <div class="table-wrap">
                        <table class="table table-admin">
                          <thead>
                            <tr>
                              <th>Username</th>
                              <th>Email</th>
                              <th>Status</th>
                              <th class="col-actions">Action</th>
                            </tr>
                          </thead>
                          <tbody>
                            {% for s in sponsor_users %}
                            <tr class="{% if not s.is_active %}row-inactive{% endif %}">
                              <td class="wrap">{{ s.username }}</td>
                              <td class="wrap">{{ s.email }}</td>
                              <td>
                                {% if s.is_active %}
                                  <span class="badge success">Active</span>
                                {% else %}
                                  <span class="badge danger">Inactive</span>
                                {% endif %}
                              </td>
                              <td class="actions">
                                <!-- View As Sponsor (Impersonation) -->
                                <form method="post" action="{% url 'accounts:view_as_sponsor' s.id %}" class="inline">
                                  {% csrf_token %}
                                  <button class="btn btn-info" type="submit" style="background:#7048e8;border-color:#7048e8;" onclick="return confirm('View the site as sponsor {{ s.username }}? You will be able to see exactly what they see.');">
                                    View As Sponsor
                                  </button>
                                </form>

                                <!-- Edit Profile -->
                                <a class="btn btn-primary" href="{% url 'accounts:admin_profile_edit' s.id %}">Edit Profile</a>

                                <form method="post" action="{% url 'accounts:toggle_user_active' s.id %}" class="inline">
                                  {% csrf_token %}
                                  {% if s == request.user %}
                                    <button class="btn" disabled>Cannot change yourself</button>
                                  {% else %}
                                    {% if s.is_active %}
                                      <button class="btn btn-warning" type="submit">Deactivate</button>
                                    {% else %}
                                      <button class="btn btn-success" type="submit">Reactivate</button>
                                    {% endif %}
                                  {% endif %}
                                </form>

                                <form method="post" action="{% url 'accounts:admin_set_temp_password' s.id %}" class="inline">
                                  {% csrf_token %}
                                  <button class="btn btn-secondary" type="submit">Temp Password</button>
                                </form>

                                <a class="btn btn-primary" href="{% url 'accounts:admin_set_password' s.id %}">Change Password</a>

                                <form method="post" action="{% url 'accounts:admin_send_reset_link' s.id %}" class="inline">
                                  {% csrf_token %}
                                  <button class="btn btn-info" type="submit">Send Reset Link</button>
                                </form>

                                <!-- Archive Sponsor -->
                                <form method="post" action="{% url 'accounts:archive_sponsor' s.id %}" class="inline">
                                  {% csrf_token %}
                                  <button class="btn btn-warning" type="submit" onclick="return confirm('Archive sponsor {{ s.username }}? They will be hidden from searches but can be unarchived later.');">
                                    Archive
                                  </button>
                                </form>

                                <form method="post" action="{% url 'accounts:admin_force_logout_user' s.id %}" class="inline">
                                  {% csrf_token %}
                                  <button class="btn btn-danger" type="submit" onclick="return confirm('Force logout this user?');">Force Logout</button>
                                </form>
                              </td>
                            </tr>
                            {% endfor %}
                          </tbody>
                        </table>
                      </div>
                    </div>
                  </section>
                  {% endif %}

                  {% if admin_users %}
                  <section class="card mt-lg">
                    <div class="card-header">
                      <div class="card-title-row">
                        <h2 class="card-title">Admin Users</h2>
                        <div class="pill muted">Showing {{ admin_users_matching_count }} / {{ total_admin_users_count }}</div>
                      </div>
                    </div>
                    <div class="card-body">
                      <div class="table-wrap">
                        <table class="table table-admin">
                          <thead>
                            <tr>
                              <th>ID</th>
                              <th>Username</th>
                              <th>Email</th>
                              <th>Name</th>
                              <th>Last Login</th>
                              <th>Status</th>
                              <th class="col-actions">Actions</th>
                            </tr>
                          </thead>
                          <tbody>
                            {% for admin in admin_users %}
                            <tr class="{% if not admin.is_active %}row-inactive{% endif %}">
                              <td class="mono">{{ admin.id }}</td>
                              <td class="wrap">{{ admin.username }}</td>
                              <td class="wrap">{{ admin.email }}</td>
                              <td class="wrap">{{ admin.get_full_name|default:"-" }}</td>
                              <td class="nowrap">
                                {% if admin.last_login %}
                                  {{ admin.last_login|date:"Y-m-d H:i" }}<br>
                                  <small class="subtle">{{ admin.last_login|timesince }} ago</small>
                                {% else %}
                                  <span class="badge danger">Never</span>
                                {% endif %}
                              </td>
                              <td>
                                {% if admin.is_superuser %}
                                  <span class="badge success">Superuser</span>
                                {% elif admin.is_staff %}
                                  <span class="badge info">Staff</span>
                                {% endif %}
                                {% if admin.is_active %}
                                  <span class="badge success">Active</span>
                                {% else %}
                                  <span class="badge danger">Inactive</span>
                                {% endif %}
                              </td>
                              <td class="actions">
                                <!-- View Details -->
                                <a class="btn btn-info" href="{% url 'accounts:admin_detail' admin.id %}">
                                  ðŸ“‹ View Details
                                </a>
                              </td>
                            </tr>
                            {% endfor %}
                          </tbody>
                        </table>
                      </div>
                    </div>
                  </section>
                  {% endif %}
                </div>

                <script>
                (function () {
                  const els = document.querySelectorAll('.autocomplete');
                  if (!els.length) return;

                  function h(tag, cls, text){ const e=document.createElement(tag); if(cls) e.className=cls; if(text) e.textContent=text; return e; }

                  els.forEach(wrapper => {
                    const input = wrapper.querySelector('.ac-input') || wrapper.querySelector('input');
                    const panel = wrapper.querySelector('.ac-panel');
                    const endpoint = wrapper.dataset.endpoint;
                    const limit = parseInt(wrapper.dataset.limit || "8", 10);

                    let aborter = null, items = [], index = -1, lastQ = "";

                    function clearPanel(){
                      panel.innerHTML = "";
                      panel.hidden = true;
                      wrapper.classList.remove('open');
                      items = []; index = -1;
                    }

                    function render(list){
                      panel.innerHTML = "";
                      list.slice(0, limit).forEach((row) => {
                        const it = h('div', 'ac-item'); it.setAttribute('role','option');
                        it.dataset.value = row.value || row.label || "";
                        it.append(h('div','ac-label', row.label || row.value || ""));
                        if (row.hint) it.append(h('div','ac-hint', row.hint));
                        it.addEventListener('mousedown', (e)=>{ e.preventDefault(); commit(it.dataset.value); });
                        panel.append(it);
                      });
                      panel.hidden = list.length === 0;
                      if (!panel.hidden) wrapper.classList.add('open');
                      items = Array.from(panel.children);
                      index = items.length ? 0 : -1;
                      highlight();
                    }

                    function highlight(){ items.forEach((el,i)=>el.setAttribute('aria-selected', i===index ? 'true':'false')); }
                    function commit(val){ input.value = val; clearPanel(); }

                    async function fetchData(q){
                      if (!endpoint || !q) { clearPanel(); return; }
                      try {
                        if (aborter) aborter.abort();
                        aborter = new AbortController();
                        const res = await fetch(`${endpoint}?q=` + encodeURIComponent(q), {signal:aborter.signal});
                        const data = await res.json();
                        render(Array.isArray(data) ? data : []);
                      } catch (_) {}
                    }

                    input.setAttribute('autocomplete','off');
                    input.addEventListener('input', (e) => {
                      const q = e.target.value.trim();
                      if (q === lastQ) return; lastQ = q;
                      if (!q) { clearPanel(); return; }
                      fetchData(q);
                    });

                    input.addEventListener('keydown', (e) => {
                      if (panel.hidden) return;
                      if (e.key === 'ArrowDown'){ e.preventDefault(); index = Math.min(index+1, items.length-1); highlight(); }
                      else if (e.key === 'ArrowUp'){ e.preventDefault(); index = Math.max(index-1, 0); highlight(); }
                      else if (e.key === 'Enter'){ if (index>=0){ e.preventDefault(); commit(items[index].dataset.value); } }
                      else if (e.key === 'Escape'){ clearPanel(); }
                    });

                    input.addEventListener('blur', () => setTimeout(clearPanel, 100));
                  });
                })();
                </script>

                {% if failed_logins %}
                  <h2>Recent Failed Login Attempts</h2>
                  <table class="table">
                    <thead>
                      <tr>
                        <th>Username</th>
                        <th>IP Address</th>
                        <th>Timestamp</th>
                      </tr>
                    </thead>
                    <tbody>
                      {% for attempt in failed_logins %}
                      <tr>
                        <td>{{ attempt.username }}</td>
                        <td>{{ attempt.ip_address }}</td>
                        <td>{{ attempt.timestamp|date:"Y-m-d H:i:s" }}</td>
                      </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                {% endif %}

                {% endblock content %}
