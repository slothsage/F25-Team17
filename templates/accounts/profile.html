{% extends "base.html" %}
{% block title %}My Profile{% endblock title %}

{% block content %}
<h1>My Profile</h1>

{% if show_points and total_points is not None %}
<div class="points-summary card shadow-sm mb-4 border-0">
  <div class="card-body">
    <div class="d-flex flex-column flex-md-row align-items-md-center justify-content-between gap-3 mb-3">
      <div class="d-flex align-items-center gap-3">
        <div class="points-circle text-white">
          <i class="fas fa-star"></i>
        </div>
        <div>
          <p class="text-uppercase text-muted mb-1 small">Total Points</p>
          <p class="h2 mb-0 fw-bold">{{ total_points|default:0 }} <span class="fs-6 text-muted">pts</span></p>
        </div>
      </div>
      <div class="d-flex gap-2 flex-wrap">
        <a class="btn btn-outline-primary btn-lg px-4" href="{% url 'accounts:points_history' %}" style="text-decoration: none;">
          View History
        </a>
        <a class="btn btn-primary btn-lg px-4" href="{% url 'accounts:points_goal_tracker' %}" style="text-decoration: none;">
          {% if has_goal %}Update Goal{% else %}Set Goal{% endif %}
        </a>
      </div>
    </div>
    
    {% if has_goal %}
      <!-- Progress Bar Section -->
      <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--border, #dee2e6);">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
          <span style="font-weight: 600; font-size: 0.9rem;">Goal: {{ points_goal|floatformat:0 }} points</span>
          <span style="font-weight: 600; color: var(--primary, #007bff); font-size: 0.9rem;">{{ progress_percentage }}%</span>
        </div>
        
        <!-- Progress Bar Container -->
        <div style="background: var(--bg-secondary, #e9ecef); border-radius: 0.5rem; height: 1.5rem; position: relative; overflow: hidden; border: 1px solid var(--border, #dee2e6);">
          <!-- Progress Bar Fill -->
          <div style="
            background: {% if progress_percentage >= 100 %}linear-gradient(90deg, #28a745 0%, #20c997 100%);
            {% elif progress_percentage >= 75 %}linear-gradient(90deg, #007bff 0%, #0056b3 100%);
            {% elif progress_percentage >= 50 %}linear-gradient(90deg, #17a2b8 0%, #138496 100%);
            {% elif progress_percentage >= 25 %}linear-gradient(90deg, #ffc107 0%, #e0a800 100%);
            {% else %}linear-gradient(90deg, #dc3545 0%, #c82333 100%);{% endif %}
            height: 100%;
            width: {{ progress_percentage }}%;
            transition: width 0.3s ease;
            border-radius: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 0.75rem;
          ">
            {% if progress_percentage > 15 %}{{ progress_percentage }}%{% endif %}
          </div>
        </div>
        
        {% if progress_percentage >= 100 %}
          <p style="margin-top: 0.5rem; margin-bottom: 0; color: #28a745; font-weight: 600; font-size: 0.9rem;">
            ðŸŽ‰ Goal achieved! You have {{ total_points|floatformat:0 }} points!
          </p>
        {% else %}
          <p style="margin-top: 0.5rem; margin-bottom: 0; color: var(--muted, #6c757d); font-size: 0.85rem;">
            {{ points_remaining|floatformat:0 }} points remaining
          </p>
        {% endif %}
      </div>
    {% else %}
      <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--border, #dee2e6); text-align: center;">
        <p style="color: var(--muted, #6c757d); margin: 0; font-size: 0.9rem;">
          Set a points goal to track your progress!
        </p>
      </div>
    {% endif %}
  </div>
</div>
{% endif %}

<style>
.points-summary {
  background: linear-gradient(135deg, #eef4ff, #ffffff);
  border-left: 5px solid #0d6efd;
}
.points-circle {
  width: 64px;
  height: 64px;
  border-radius: 50%;
  background: #0d6efd;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.5rem;
  box-shadow: inset 0 0 10px rgba(255,255,255,0.25);
}
@media (max-width: 576px) {
  .points-summary .btn {
    width: 100%;
  }
}
</style>

<div class="profile-picture-section">
  {% if request.user.driver_profile and request.user.driver_profile.image %}
    <p>
      <img src="{{ request.user.driver_profile.image.url }}" alt="Profile photo" style="width:120px;height:120px;object-fit:cover;border-radius:60px;border:1px solid #ddd;">
    </p>
  {% else %}
    <p>
      <div style="width:120px;height:120px;background-color:#f0f0f0;border-radius:60px;border:1px solid #ddd;display:flex;align-items:center;justify-content:center;">
        <span style="color:#999;font-size:12px;">No photo</span>
      </div>
    </p>
  {% endif %}
  <p>
    <a class="btn btn-sm btn-info" href="{% url 'accounts:profile_picture_edit' %}" style="text-decoration: none;">Edit Profile Picture</a>
  </p>
</div>
<p><b>Username:</b> {{ request.user.username }}</p>
<p><b>Email:</b> {{ request.user.email }}</p>

{% if request.user.driver_profile %}
  <p><b>Name:</b>
    {{ request.user.driver_profile.first_name }}
    {{ request.user.driver_profile.last_name }}</p>
  <p><b>Phone:</b> {{ request.user.driver_profile.phone }}</p>
  <p><b>Address:</b> {{ request.user.driver_profile.address }}</p>
  <p><b>City/State/Zip:</b>
    {{ request.user.driver_profile.city }},
    {{ request.user.driver_profile.state }}
    {{ request.user.driver_profile.zip_code }}</p>
{% if request.user.driver_profile.description %}
  <p><strong>Description:</strong> {{ request.user.driver_profile.description }}</p>
{% endif %}
{% else %}
  <p>No driver profile found yet.</p>
{% endif %}

<!-- Profile Action Buttons -->
<div style="margin-top: 1.5rem; display: flex; gap: 0.75rem; flex-wrap: wrap; align-items: center;">
  <a class="btn btn-sm btn-primary" href="{% url 'accounts:profile_edit' %}" style="text-decoration: none;">
    <i class="fas fa-user-edit" style="margin-right: 6px;"></i>Edit Profile
  </a>
  <a class="btn btn-sm btn-outline-primary" href="{% url 'accounts:profile_preview' %}" style="text-decoration: none;">
    <i class="fas fa-eye" style="margin-right: 6px;"></i>Preview as Sponsor
  </a>
  
  <!-- Driver-specific links (only for drivers who are not sponsors or admins) -->
  {% if request.user.driver_profile and not is_sponsor and not is_admin %}
    <a class="btn btn-sm btn-outline-secondary" href="{% url 'accounts:driver_security_log' %}" style="text-decoration: none;">
      <i class="fas fa-shield-alt" style="margin-right: 6px;"></i>Security Log
    </a>
  {% endif %}
</div>

<hr>
<h2>Multi-Factor Authentication</h2>

<p>Status:
  {% if request.user.mfa and request.user.mfa.mfa_enabled %}
    <strong>Enabled</strong>
  {% else %}
    <strong>Disabled</strong>
  {% endif %}
</p>

<form method="post" action="{% url 'accounts:mfa_toggle' %}" onsubmit="return confirmToggle();">
  {% csrf_token %}
  {% if request.user.mfa and request.user.mfa.mfa_enabled %}
    <input type="hidden" name="action" value="disable">
    <p>Enter a 6-digit code to disable:</p>
  {% else %}
    <input type="hidden" name="action" value="enable">
    <p>Enter a 6-digit code to enable:</p>
    <p class="text-sm">
      First time? <a href="{% url 'accounts:mfa_setup' %}">Set up your authenticator app</a> to get a code.
    </p>
  {% endif %}

  <input name="code" maxlength="6" required inputmode="numeric" pattern="[0-9]{6}"
        placeholder="123456" autocomplete="one-time-code">
  <button type="submit">
    {% if request.user.mfa and request.user.mfa.mfa_enabled %}Disable MFA{% else %}Enable MFA{% endif %}
  </button>
</form>

<script>
function confirmToggle() {
  // Optional extra safety
  return confirm('Are you sure? This action requires a valid 6-digit code.');
}
</script>

{% endblock content %}