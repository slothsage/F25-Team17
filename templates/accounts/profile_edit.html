{% extends "base.html" %}
{% load static %}
{% block title %}Edit Profile{% endblock title %}

{% block content %}
{% if is_admin_edit %}
<h1>Edit Profile for {{ editing_user.username }}</h1>
<p class="info-message">You are editing this user's profile as an administrator.</p>
{% else %}
<h1>Edit Profile</h1>
{% endif %}

<form id="profile-edit-form" method="post" enctype="multipart/form-data">
  {% csrf_token %}
  {{ form.non_field_errors }}

  {# Email comes from the form's __init__ #}
  <p>{{ form.email.label_tag }} {{ form.email }}</p>

  {# Render all fields EXCEPT image, description, and email #}
  {% for field in form.visible_fields %}
    {% if field.name != "image" and field.name != "description" and field.name != "email" %}
      <p>
        {{ field.label_tag }} {{ field }}
        {% if field.errors %}<div class="error">{{ field.errors }}</div>{% endif %}
      </p>
    {% endif %}
  {% endfor %}

  {# Single image uploader + current/placeholder preview (only for non-admin edits) #}
  {% if not is_admin_edit %}
  <p>
    <label for="{{ form.image.id_for_label }}">Profile photo</label><br>
    {{ form.image }}
    <br><small>Current:</small><br>
    {% if request.user.driver_profile and request.user.driver_profile.image %}
      <img src="{{ request.user.driver_profile.image.url }}"
          alt="Current photo"
          style="width:80px;height:80px;object-fit:cover;border-radius:40px;border:1px solid #ddd;">
    {% else %}
      <img src="{% static 'defaults/avatar.png' %}"
          alt="Default avatar"
          style="width:80px;height:80px;object-fit:cover;border-radius:40px;border:1px solid #ddd;">
    {% endif %}
    {% if form.image.errors %}<div class="error">{{ form.image.errors }}</div>{% endif %}
  </p>
  {% endif %}

  {# Description once #}
  <p>
    {{ form.description.label_tag }}<br>
    {{ form.description }}
    {% if form.description.errors %}<div class="error">{{ form.description.errors }}</div>{% endif %}
  </p>

  <button type="submit" id="save-profile-btn" class="btn btn-primary">Save changes</button>
</form>

<script>
  (function () {
    const form = document.getElementById('profile-edit-form');
    if (!form) return;

    let submitting = false;

    form.addEventListener('submit', function (e) {
      if (submitting) return;
      e.preventDefault();

      const ok = window.confirm('Save these changes to your profile?');
      if (ok) {
        submitting = true;
        form.submit();
      }
    });
  })();
</script>
{% endblock content %}
