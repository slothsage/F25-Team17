{% extends "base.html" %}

{% block title %}My Drivers{% endblock %}

{% block content %}
<div class="container-fluid mt-4 mb-5">
  <!-- Header + Search -->
  <div class="card shadow-sm border-0 mb-4">
    <div class="card-header bg-white border-bottom py-3">
      <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
        <div>
          <h1 class="h4 mb-1">My Drivers</h1>
          <p class="text-muted small mb-0">
            Search your roster, see wallet balances, and quickly award or deduct points.
          </p>
        </div>
        {% if drivers %}
        <span class="badge bg-primary fs-6 px-3 py-2">
          {{ drivers.paginator.count }} driver{% if drivers.paginator.count != 1 %}s{% endif %}
        </span>
        {% endif %}
      </div>
    </div>
    <div class="card-body">
      <form method="get" class="row g-3 align-items-center">
        <div class="col-lg-6 col-md-8">
          <label class="form-label fw-semibold small text-uppercase text-muted mb-1">
            Search drivers
          </label>
          <input
            type="text"
            name="q"
            value="{{ q }}"
            class="form-control"
            placeholder="username, email, phone, address or id:123"
            autocomplete="off"
          />
        </div>
        <div class="col-lg-3 col-md-4 d-flex align-items-end">
          <button class="btn btn-primary w-100" type="submit">
            <i class="fas fa-search me-2"></i>Search
          </button>
        </div>
        {% if q %}
        <div class="col-lg-3 d-flex align-items-end">
          <a href="?" class="btn btn-outline-secondary w-100">
            Clear
          </a>
        </div>
        {% endif %}
      </form>
    </div>
  </div>

  <!-- Results -->
  <div class="card shadow-sm border-0">
    {% if drivers %}
    <div class="card-body p-0">
      <div class="scrollable-table-container">
        <table class="table table-hover mb-0 align-middle">
          <thead class="table-light">
            <tr>
              <th style="width: 70px;" class="ps-3">ID</th>
              <th>Driver</th>
              <th>Phone</th>
              <th>Address</th>
              <th>Last Login</th>
              <th>Wallet ({{ sponsor.username }})</th>
              <th style="width: 280px;" class="pe-3">Award / Deduct</th>
            </tr>
          </thead>
          <tbody>
            {% for u in drivers %}
            <tr{% if not u.is_active or u.driver_profile.is_locked or u.driver_profile.is_suspended %} class="{% if not u.is_active or u.driver_profile.is_locked %}table-danger{% elif u.driver_profile.is_suspended %}table-warning{% endif %}"{% endif %}>
              <td class="text-muted small ps-3">{{ u.id }}</td>
              <td>
                <div class="fw-semibold">{{ u.username }}</div>
                <div class="small text-muted">{{ u.email }}</div>
              </td>
              <td class="small">{{ u.driver_profile.phone|default:"—" }}</td>
              <td class="small">{{ u.driver_profile.address|truncatechars:30|default:"—" }}</td>
              <td class="small">
                {% if u.last_login %}
                  <div>{{ u.last_login|date:"M d, Y" }}</div>
                  <span class="text-muted">{{ u.last_login|timesince }} ago</span>
                {% else %}
                  <span class="badge bg-secondary">Never</span>
                {% endif %}
              </td>
              <td>
                {% if u.sponsor_balance is not None %}
                  <span class="badge bg-primary">{{ u.sponsor_balance }} pts</span>
                {% else %}
                  <span class="badge bg-light text-muted">0 pts</span>
                {% endif %}
              </td>
              <td class="pe-3">
                <div class="d-flex flex-wrap gap-2 align-items-center justify-content-end">
                  <a href="{% url 'accounts:sponsor_view_driver_profile' u.id %}" class="btn btn-sm btn-outline-primary" title="View Profile">
                    <i class="fas fa-user me-1"></i>View Profile
                  </a>
                  <form method="post" class="d-flex flex-wrap gap-2 align-items-center">
                    {% csrf_token %}
                    <input type="hidden" name="driver_id" value="{{ u.id }}">
                    <input
                      type="number"
                      name="amount"
                      min="1"
                      step="1"
                      placeholder="Points"
                      required
                      class="form-control form-control-sm"
                      style="width: 90px;"
                    />
                    <input
                      type="text"
                      name="reason"
                      placeholder="Reason (optional)"
                      class="form-control form-control-sm flex-grow-1"
                    />
                    <button class="btn btn-sm btn-outline-success" name="action" value="award" type="submit">
                      <i class="fas fa-plus me-1"></i>Award
                    </button>
                    <button class="btn btn-sm btn-outline-danger" name="action" value="deduct" type="submit">
                      <i class="fas fa-minus me-1"></i>Deduct
                    </button>
                  </form>
                </div>
              </td>
            </tr>
            {% empty %}
            <tr>
              <td colspan="7" class="text-center text-muted py-5">
                <i class="fas fa-inbox fa-2x mb-2 d-block"></i>
                No drivers found in your roster.
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
    {% if drivers.has_other_pages %}
    <div class="card-footer bg-white border-top py-3">
      <nav aria-label="Driver pagination">
        <ul class="pagination mb-0 justify-content-center">
          {% if drivers.has_previous %}
          <li class="page-item">
            <a
              class="page-link"
              href="?q={{ q }}&page={{ drivers.previous_page_number }}"
            >
              <i class="fas fa-chevron-left me-1"></i>Previous
            </a>
          </li>
          {% endif %}
          <li class="page-item disabled">
            <span class="page-link">
              Page {{ drivers.number }} of {{ drivers.paginator.num_pages }}
            </span>
          </li>
          {% if drivers.has_next %}
          <li class="page-item">
            <a
              class="page-link"
              href="?q={{ q }}&page={{ drivers.next_page_number }}"
            >
              Next<i class="fas fa-chevron-right ms-1"></i>
            </a>
          </li>
          {% endif %}
        </ul>
      </nav>
    </div>
    {% endif %}
    {% else %}
    <div class="card-body text-center py-5">
      <i class="fas fa-users fa-3x mb-3 text-muted"></i>
      <h5 class="mb-2">No drivers found in your roster</h5>
      <p class="text-muted mb-0">
        Try adjusting your search or check back after drivers have been added to your team.
      </p>
    </div>
    {% endif %}
  </div>
</div>

<style>
.scrollable-table-container {
  max-height: 600px;
  overflow-y: auto;
  overflow-x: auto;
}

.scrollable-table-container thead th {
  position: sticky;
  top: 0;
  background-color: #f8f9fa;
  z-index: 10;
  box-shadow: 0 2px 2px -1px rgba(0, 0, 0, 0.1);
}

.table th {
  font-weight: 600;
  font-size: 0.875rem;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  padding: 1rem 0.75rem;
}

.table td {
  padding: 0.75rem 0.75rem;
  vertical-align: middle;
}
</style>

{% endblock content %}