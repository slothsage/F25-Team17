{% extends "base.html" %}
{% block content %}
    <h1>Messages</h1>

    <div style="margin-bottom:1rem;">
        <a href="{% url 'accounts:message_compose' %}" class="btn">Compose</a>
        <a href="{% url 'accounts:messages_sent' %}" class="btn">Sent</a>
    </div>

    {# Bulk delete form ONLY #}
    <form id="bulk-delete-form" method="post" action="{% url 'accounts:messages_bulk_delete' %}">
        {% csrf_token %}
        <div style="margin:.5rem 0;">
            <button class="btn" type="submit">Delete selected</button>
            <label style="margin-left:1rem;">
                <input type="checkbox" id="select-all"> Select all
            </label>
        </div>
    </form>

    {% if rows %}
    <ul>
    {% for r in rows %}
        <li>
            <label style="margin-right:.5rem;">
                {# Associate checkbox with bulk-delete-form via form="bulk-delete-form" #}
                <input type="checkbox" form="bulk-delete-form" name="ids" value="{{ r.pk }}">
            </label>
            {% if not r.is_read %}<strong>[new]</strong>{% endif %}
            <a href="{% url 'accounts:messages_detail' r.pk %}">{{ r.message.subject }}</a>
            — from {{ r.message.author.username }} — {{ r.message.created_at|date:"Y-m-d H:i" }}

            {# Single delete form per row (NOT nested anymore) #}
            <form method="post" action="{% url 'accounts:messages_delete' r.pk %}" style="display:inline;">
                {% csrf_token %}
                <button class="btn" type="submit" onclick="return confirm('Delete this message?')">
                    Delete
                </button>
            </form>
        </li>
    {% endfor %}
    </ul>

    <script>
    (function(){
        var all = document.getElementById('select-all');
        if (!all) return;
        all.addEventListener('change', function(){
        document.querySelectorAll('input[name="ids"]').forEach(function(cb){ cb.checked = all.checked; });
        });
    })();
    </script>

    {% else %}
        <p>No messages in your inbox.</p>
    {% endif %}
{% endblock content %}
