{% extends "base.html" %}
{% load i18n %}

{% block title %}Admin: User Search{% endblock %}

{% block content %}
<div class="container-fluid mt-4 mb-5">
  <!-- Header Section -->
  <div class="header-section mb-4">
    <h1 class="page-title">User Management</h1>
    <div class="action-bar">
      <a href="{% url 'accounts:login_activity' %}">Login Activity</a>
      <a href="{% url 'accounts:admin_active_sessions' %}">Active Sessions</a>
      <a href="{% url 'accounts:archived_sponsors' %}">Archived Sponsors</a>
      <a href="{% url 'accounts:bulk_upload_users' %}">Bulk Upload</a>
      <a href="{% url 'accounts:bulk_assign_sponsorship' %}">Bulk Assign</a>
      <form method="get" action="{% url 'accounts:download_error_log' %}">
        <input type="date" name="date" placeholder="Select date">
        <button type="submit">Logs</button>
      </form>
    </div>
  </div>

  <!-- Label Management Bar -->
  <div class="label-section mb-4">
    <div style="display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
      <span style="font-weight: 500; color: #333;">Filter by Label:</span>
      <form method="get" style="margin: 0;">
        <select name="label" onchange="this.form.submit()" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px; background: white;">
          <option value="">-- All Labels --</option>
          {% for label in labels %}
            <option value="{{ label.name }}" {% if label.name == selected_label %}selected{% endif %}>
              {{ label.name }}
            </option>
          {% endfor %}
        </select>
      </form>
      {% if selected_label %}
        <a href="?" style="padding: 8px 16px; background: #f8f9fa; border: 1px solid #ddd; border-radius: 4px; text-decoration: none; color: #333;">Clear</a>
      {% endif %}
      <a href="{% url 'accounts:manage_labels' %}" style="padding: 8px 16px; background: #f8f9fa; border: 1px solid #ddd; border-radius: 4px; text-decoration: none; color: #333;">Manage Labels</a>
      <a href="{% url 'accounts:assign_labels' %}" style="padding: 8px 16px; background: #f8f9fa; border: 1px solid #ddd; border-radius: 4px; text-decoration: none; color: #333;">Assign Labels</a>
    </div>
  </div>

  <!-- Search Cards -->
  <div class="card shadow-sm border-0 mb-4">
    <div class="card-header bg-white border-bottom py-3">
      <h5 class="mb-0 fw-bold">
        <i class="fas fa-search me-2 text-primary"></i>Search Users
      </h5>
    </div>
    <div class="card-body">
      <div class="search-grid">
        <!-- Driver Search -->
        <div class="search-column">
          <div class="search-section">
            <h6 class="search-title text-primary mb-3">
              <i class="fas fa-user me-2"></i>Driver Search
            </h6>
            <form method="get">
              <div class="autocomplete mb-3" data-limit="6" data-endpoint="{% url 'accounts:api_driver_suggest' %}">
                <input
                  name="q"
                  value="{{ q }}"
                  class="form-control ac-input"
                  placeholder="username, email, phone, id:123"
                  autocomplete="off"
                />
                <div class="ac-panel" role="listbox" hidden></div>
              </div>
              <button class="btn btn-primary w-100" type="submit">
                <i class="fas fa-search me-2"></i>Search Drivers
              </button>
            </form>
          </div>
        </div>

        <!-- Sponsor Search -->
        <div class="search-column">
          <div class="search-section">
            <h6 class="search-title text-success mb-3">
              <i class="fas fa-handshake me-2"></i>Sponsor Search
            </h6>
            <form method="get">
              <div class="autocomplete mb-3" data-limit="6" data-endpoint="{% url 'accounts:api_sponsor_suggest' %}">
                <input
                  name="sponsor"
                  value="{{ sponsor_q }}"
                  class="form-control ac-input"
                  placeholder="sponsor name, email"
                  autocomplete="off"
                />
                <div class="ac-panel" role="listbox" hidden></div>
              </div>
              <button class="btn btn-success w-100" type="submit">
                <i class="fas fa-search me-2"></i>Search Sponsors
              </button>
            </form>
          </div>
        </div>

        <!-- Admin Search -->
        <div class="search-column">
          <div class="search-section">
            <h6 class="search-title text-info mb-3">
              <i class="fas fa-user-shield me-2"></i>Admin Search
            </h6>
            <form method="get">
              <input
                name="admin"
                value="{{ admin_q }}"
                class="form-control mb-3"
                placeholder="username, email, name"
                autocomplete="off"
              />
              <button class="btn btn-info w-100" type="submit">
                <i class="fas fa-search me-2"></i>Search Admins
              </button>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Export Card -->
  <div class="row mb-4">
    <div class="col-md-12">
      <div class="card shadow-sm border-0">
        <div class="card-header bg-secondary text-white py-3">
          <h6 class="mb-0 fw-semibold">
            <i class="fas fa-download me-2"></i>Export Data
          </h6>
        </div>
        <div class="card-body">
          <div class="d-flex gap-3 flex-wrap">
            <form method="get" class="d-inline">
              <input type="hidden" name="q" value="{{ q }}" />
              <input type="hidden" name="sponsor" value="{{ sponsor_q }}" />
              <input type="hidden" name="export" value="csv" />
              <input type="hidden" name="export_type" value="drivers" />
              <button class="btn btn-outline-secondary" type="submit">
                <i class="fas fa-file-csv me-2"></i>Export Drivers CSV
              </button>
            </form>
            <form method="get" class="d-inline">
              <input type="hidden" name="q" value="{{ q }}" />
              <input type="hidden" name="sponsor" value="{{ sponsor_q }}" />
              <input type="hidden" name="export" value="csv" />
              <input type="hidden" name="export_type" value="sponsors" />
              <button class="btn btn-outline-secondary" type="submit">
                <i class="fas fa-file-csv me-2"></i>Export Sponsors CSV
              </button>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Drivers Table -->
  <div class="card shadow-sm border-0 mb-4">
    <div class="card-header bg-white border-bottom py-3" style="cursor: pointer;" onclick="toggleSection('drivers-section')">
      <div class="d-flex justify-content-between align-items-center">
        <h5 class="mb-0 fw-bold">
          <i class="fas fa-users me-2 text-primary"></i>Drivers
          <i class="fas fa-chevron-down ms-2" id="drivers-chevron"></i>
        </h5>
        <span class="badge bg-primary fs-6 px-3 py-2">{{ drivers_matching_count }} / {{ total_drivers_count }}</span>
      </div>
    </div>
    <div id="drivers-section">
    <div class="card-body p-0">
      <div class="scrollable-table-container">
        <table class="table table-hover mb-0 align-middle">
          <thead class="table-light">
            <tr>
              <th style="width: 70px;" class="ps-3">ID</th>
              <th>Username</th>
              <th>Email</th>
              <th>Phone</th>
              <th>Address</th>
              <th>Labels</th>
              <th>
                {% with current_q=request.GET.q|default:"" current_label=request.GET.label|default:"" %}
                  {% if request.GET.sort == "sponsor_asc" %}
                    <a href="?q={{ current_q }}&label={{ current_label }}&sort=sponsor_desc" class="text-decoration-none text-dark">
                      Sponsor <i class="fas fa-sort-down"></i>
                    </a>
                  {% elif request.GET.sort == "sponsor_desc" %}
                    <a href="?q={{ current_q }}&label={{ current_label }}&sort=sponsor_asc" class="text-decoration-none text-dark">
                      Sponsor <i class="fas fa-sort-up"></i>
                    </a>
                  {% else %}
                    <a href="?q={{ current_q }}&label={{ current_label }}&sort=sponsor_asc" class="text-decoration-none text-muted">
                      Sponsor <i class="fas fa-sort"></i>
                    </a>
                  {% endif %}
                {% endwith %}
              </th>
              <th>Last Login</th>
              <th style="width: 180px;" class="pe-3">Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for u in drivers %}
            <tr {% if not u.is_active %}class="table-danger"{% elif u.driver_profile.is_locked %}class="table-danger"{% elif u.driver_profile.is_suspended %}class="table-warning"{% endif %}>
              <td class="text-muted small ps-3">{{ u.id }}</td>
              <td><strong>{{ u.username }}</strong></td>
              <td class="small">{{ u.email|truncatechars:30 }}</td>
              <td class="small">{{ u.driver_profile.phone|default:"—" }}</td>
              <td class="small">{{ u.driver_profile.address|truncatechars:25|default:"—" }}</td>
              <td>
                {% for label in u.driver_profile.labels.all %}
                  <span class="badge me-1 mb-1" style="background-color: {{ label.color }}; color: #fff;">{{ label.name }}</span>
                {% empty %}
                  <span class="text-muted">—</span>
                {% endfor %}
              </td>
              <td>
                  {% if u.driver_profile.sponsors.all %}
                      {% for s in u.driver_profile.sponsors.all %}
                          <span class="badge info" style="margin-right:4px;">
                              {{ s.username }}
                          </span>
                      {% endfor %}
                  {% else %}
                      <span class="muted">No Sponsors</span>
                  {% endif %}
              </td>
              <td class="small">
                {% if u.last_login %}
                  <div>{{ u.last_login|date:"M d, Y" }}</div>
                  <span class="text-muted">{{ u.last_login|timesince }} ago</span>
                {% else %}
                  <span class="badge bg-secondary">Never</span>
                {% endif %}
              </td>
              <td class="pe-3">
                <div class="dropdown">
                  <button type="button" class="btn btn-sm btn-outline-primary dropdown-toggle" aria-expanded="false">
                    <i class="fas fa-cog me-1"></i>Actions
                  </button>
                  <ul class="dropdown-menu dropdown-menu-end shadow">
                    <li>
                      <form method="post" action="{% url 'accounts:view_as_driver' u.id %}" class="d-inline">
                        {% csrf_token %}
                        <button class="dropdown-item" type="submit" onclick="return confirm('View as {{ u.username }}?');">
                          <i class="fas fa-eye me-2"></i>View As Driver
                        </button>
                      </form>
                    </li>
                    <li><a class="dropdown-item" href="{% url 'accounts:admin_profile_edit' u.id %}"><i class="fas fa-edit me-2"></i>Edit Profile</a></li>
                    <li><a class="dropdown-item" href="{% url 'accounts:admin_manage_driver_sponsors' u.id %}"><i class="fas fa-users-cog me-2"></i>Manage Sponsors</a></li>
                    <li><hr class="dropdown-divider"></li>
                    <li>
                      <form method="post" action="{% url 'accounts:toggle_user_active' u.id %}" class="d-inline">
                        {% csrf_token %}
                        {% if u != request.user %}
                          <button class="dropdown-item" type="submit">
                            <i class="fas fa-{% if u.is_active %}ban{% else %}check{% endif %} me-2"></i>{% if u.is_active %}Deactivate{% else %}Reactivate{% endif %}
                          </button>
                        {% endif %}
                      </form>
                    </li>
                    <li>
                      <form method="post" action="{% url 'accounts:toggle_lock_user' u.id %}" class="d-inline">
                        {% csrf_token %}
                        <button class="dropdown-item" type="submit" onclick="return confirm('{% if u.driver_profile.is_locked %}Unlock{% else %}Lock{% endif %} this user?');">
                          <i class="fas fa-{% if u.driver_profile.is_locked %}unlock{% else %}lock{% endif %} me-2"></i>{% if u.driver_profile.is_locked %}Unlock{% else %}Lock{% endif %}
                        </button>
                      </form>
                    </li>
                    <li>
                      <form method="post" action="{% url 'accounts:toggle_suspend_user' u.id %}" class="d-inline">
                        {% csrf_token %}
                        <button class="dropdown-item" type="submit" onclick="return confirm('{% if u.driver_profile.is_suspended %}Unsuspend{% else %}Suspend{% endif %} this user?');">
                          <i class="fas fa-{% if u.driver_profile.is_suspended %}check-circle{% else %}ban{% endif %} me-2"></i>{% if u.driver_profile.is_suspended %}Unsuspend{% else %}Suspend{% endif %}
                        </button>
                      </form>
                    </li>
                    <li><hr class="dropdown-divider"></li>
                    <li><a class="dropdown-item" href="{% url 'accounts:admin_set_password' u.id %}"><i class="fas fa-key me-2"></i>Change Password</a></li>
                    <li>
                      <form method="post" action="{% url 'accounts:admin_set_temp_password' u.id %}" class="d-inline">
                        {% csrf_token %}
                        <button class="dropdown-item" type="submit"><i class="fas fa-key me-2"></i>Temp Password</button>
                      </form>
                    </li>
                    <li>
                      <form method="post" action="{% url 'accounts:admin_send_reset_link' u.id %}" class="d-inline">
                        {% csrf_token %}
                        <button class="dropdown-item" type="submit"><i class="fas fa-envelope me-2"></i>Send Reset Link</button>
                      </form>
                    </li>
                    <li><a class="dropdown-item" href="{% url 'accounts:admin_set_timeout' u.id %}"><i class="fas fa-clock me-2"></i>Set Timeout</a></li>
                    <li><hr class="dropdown-divider"></li>
                    <li>
                      <form method="post" action="{% url 'accounts:admin_force_logout_user' u.id %}" class="d-inline">
                        {% csrf_token %}
                        <button class="dropdown-item text-danger" type="submit" onclick="return confirm('Force logout this user?');">
                          <i class="fas fa-sign-out-alt me-2"></i>Force Logout
                        </button>
                      </form>
                    </li>
                  </ul>
                </div>
              </td>
            </tr>
            {% empty %}
            <tr>
              <td colspan="9" class="text-center text-muted py-5">
                <i class="fas fa-inbox fa-2x mb-2 d-block"></i>
                No drivers found.
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
    {% if drivers.has_other_pages %}
    <div class="card-footer bg-white border-top py-3">
      <nav aria-label="Driver pagination">
        <ul class="pagination mb-0 justify-content-center">
          {% if drivers.has_previous %}
            <li class="page-item">
              <a class="page-link" href="?q={{ q }}&page={{ drivers.previous_page_number }}{% if request.GET.sort %}&sort={{ request.GET.sort }}{% endif %}{% if request.GET.inactive %}&inactive={{ request.GET.inactive }}{% endif %}">
                <i class="fas fa-chevron-left me-1"></i>Previous
              </a>
            </li>
          {% endif %}
          <li class="page-item disabled">
            <span class="page-link">Page {{ drivers.number }} of {{ drivers.paginator.num_pages }}</span>
          </li>
          {% if drivers.has_next %}
            <li class="page-item">
              <a class="page-link" href="?q={{ q }}&page={{ drivers.next_page_number }}{% if request.GET.sort %}&sort={{ request.GET.sort }}{% endif %}{% if request.GET.inactive %}&inactive={{ request.GET.inactive }}{% endif %}">
                Next<i class="fas fa-chevron-right ms-1"></i>
              </a>
            </li>
          {% endif %}
        </ul>
      </nav>
    </div>
    {% endif %}
    </div>
  </div>

  <!-- Sponsor Users Table -->
  {% if sponsor_users %}
  <div class="card shadow-sm border-0 mb-4">
    <div class="card-header bg-white border-bottom py-3" style="cursor: pointer;" onclick="toggleSection('sponsors-section')">
      <div class="d-flex justify-content-between align-items-center">
        <h5 class="mb-0 fw-bold">
          <i class="fas fa-handshake me-2 text-success"></i>Sponsor Users
          <i class="fas fa-chevron-down ms-2" id="sponsors-chevron"></i>
        </h5>
        <span class="badge bg-success fs-6 px-3 py-2">{{ sponsor_users|length }}</span>
      </div>
    </div>
    <div id="sponsors-section">
    <div class="card-body p-0">
      <div class="scrollable-table-container">
        <table class="table table-hover mb-0 align-middle">
          <thead class="table-light">
            <tr>
              <th class="ps-3">Username</th>
              <th>Email</th>
              <th>Status</th>
              <th style="width: 180px;" class="pe-3">Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for s in sponsor_users %}
            <tr {% if not s.is_active %}class="table-danger"{% endif %}>
              <td class="ps-3"><strong>{{ s.username }}</strong></td>
              <td class="small">{{ s.email|truncatechars:40 }}</td>
              <td>
                {% if s.is_active %}
                  <span class="badge bg-success">Active</span>
                {% else %}
                  <span class="badge bg-danger">Inactive</span>
                {% endif %}
              </td>
              <td class="pe-3">
                <div class="dropdown">
                  <button type="button" class="btn btn-sm btn-outline-success dropdown-toggle" aria-expanded="false">
                    <i class="fas fa-cog me-1"></i>Actions
                  </button>
                  <ul class="dropdown-menu dropdown-menu-end shadow">
                    <li>
                      <form method="post" action="{% url 'accounts:view_as_sponsor' s.id %}" class="d-inline">
                        {% csrf_token %}
                        <button class="dropdown-item" type="submit" onclick="return confirm('View as {{ s.username }}?');">
                          <i class="fas fa-eye me-2"></i>View As Sponsor
                        </button>
                      </form>
                    </li>
                    <li><a class="dropdown-item" href="{% url 'accounts:admin_profile_edit' s.id %}"><i class="fas fa-edit me-2"></i>Edit Profile</a></li>
                    <li><a class="dropdown-item" href="{% url 'accounts:sponsor_fee_ratio' s.id %}"><i class="fas fa-percentage me-2"></i>Fee Ratio</a></li>
                    <li><hr class="dropdown-divider"></li>
                    <li>
                      <form method="post" action="{% url 'accounts:toggle_user_active' s.id %}" class="d-inline">
                        {% csrf_token %}
                        {% if s != request.user %}
                          <button class="dropdown-item" type="submit">
                            <i class="fas fa-{% if s.is_active %}ban{% else %}check{% endif %} me-2"></i>{% if s.is_active %}Deactivate{% else %}Reactivate{% endif %}
                          </button>
                        {% endif %}
                      </form>
                    </li>
                    <li><hr class="dropdown-divider"></li>
                    <li><a class="dropdown-item" href="{% url 'accounts:admin_set_password' s.id %}"><i class="fas fa-key me-2"></i>Change Password</a></li>
                    <li>
                      <form method="post" action="{% url 'accounts:admin_set_temp_password' s.id %}" class="d-inline">
                        {% csrf_token %}
                        <button class="dropdown-item" type="submit"><i class="fas fa-key me-2"></i>Temp Password</button>
                      </form>
                    </li>
                    <li>
                      <form method="post" action="{% url 'accounts:admin_send_reset_link' s.id %}" class="d-inline">
                        {% csrf_token %}
                        <button class="dropdown-item" type="submit"><i class="fas fa-envelope me-2"></i>Send Reset Link</button>
                      </form>
                    </li>
                    <li><hr class="dropdown-divider"></li>
                    <li>
                      <form method="post" action="{% url 'accounts:archive_sponsor' s.id %}" class="d-inline">
                        {% csrf_token %}
                        <button class="dropdown-item" type="submit" onclick="return confirm('Archive {{ s.username }}?');">
                          <i class="fas fa-archive me-2"></i>Archive
                        </button>
                      </form>
                    </li>
                    <li>
                      <form method="post" action="{% url 'accounts:admin_force_logout_user' s.id %}" class="d-inline">
                        {% csrf_token %}
                        <button class="dropdown-item text-danger" type="submit" onclick="return confirm('Force logout?');">
                          <i class="fas fa-sign-out-alt me-2"></i>Force Logout
                        </button>
                      </form>
                    </li>
                  </ul>
                </div>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
    </div>
  </div>
  {% endif %}

  <!-- Admin Users Table -->
  {% if admin_users %}
  <div class="card shadow-sm border-0 mb-4">
    <div class="card-header bg-white border-bottom py-3" style="cursor: pointer;" onclick="toggleSection('admins-section')">
      <div class="d-flex justify-content-between align-items-center">
        <h5 class="mb-0 fw-bold">
          <i class="fas fa-user-shield me-2 text-info"></i>Admin Users
          <i class="fas fa-chevron-down ms-2" id="admins-chevron"></i>
        </h5>
        <span class="badge bg-info fs-6 px-3 py-2">{{ admin_users_matching_count }} / {{ total_admin_users_count }}</span>
      </div>
    </div>
    <div id="admins-section">
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-hover mb-0 align-middle">
          <thead class="table-light">
            <tr>
              <th style="width: 70px;" class="ps-3">ID</th>
              <th>Username</th>
              <th>Email</th>
              <th>Name</th>
              <th>Last Login</th>
              <th>Status</th>
              <th style="width: 150px;" class="pe-3">Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for admin in admin_users %}
            <tr {% if not admin.is_active %}class="table-danger"{% endif %}>
              <td class="text-muted small ps-3">{{ admin.id }}</td>
              <td><strong>{{ admin.username }}</strong></td>
              <td class="small">{{ admin.email|truncatechars:30 }}</td>
              <td>{{ admin.get_full_name|default:"—" }}</td>
              <td class="small">
                {% if admin.last_login %}
                  <div>{{ admin.last_login|date:"M d, Y" }}</div>
                  <span class="text-muted">{{ admin.last_login|timesince }} ago</span>
                {% else %}
                  <span class="badge bg-secondary">Never</span>
                {% endif %}
              </td>
              <td>
                {% if admin.is_superuser %}
                  <span class="badge bg-danger me-1">Superuser</span>
                {% elif admin.is_staff %}
                  <span class="badge bg-info me-1">Staff</span>
                {% endif %}
                {% if admin.is_active %}
                  <span class="badge bg-success">Active</span>
                {% else %}
                  <span class="badge bg-danger">Inactive</span>
                {% endif %}
              </td>
              <td class="pe-3">
                <a class="btn btn-sm btn-outline-info" href="{% url 'accounts:admin_detail' admin.id %}">
                  <i class="fas fa-info-circle me-1"></i>Details
                </a>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
    </div>
  </div>
  {% endif %}

  <!-- Legacy Sponsors Table (if exists) -->
  {% if sponsors %}
  <div class="card shadow-sm border-0 mb-4">
    <div class="card-header bg-white border-bottom py-3" style="cursor: pointer;" onclick="toggleSection('legacy-sponsors-section')">
      <div class="d-flex justify-content-between align-items-center">
        <h5 class="mb-0 fw-bold">
          <i class="fas fa-building me-2 text-warning"></i>Legacy Sponsors
          <i class="fas fa-chevron-down ms-2" id="legacy-sponsors-chevron"></i>
        </h5>
        <span class="badge bg-warning text-dark fs-6 px-3 py-2">{{ sponsors_matching_count }} / {{ total_sponsors_count }}</span>
      </div>
    </div>
    <div id="legacy-sponsors-section">
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-hover mb-0 align-middle">
          <thead class="table-light">
            <tr>
              <th class="ps-3">Name</th>
              <th>Order Count</th>
              <th class="pe-3">Sample Drivers</th>
            </tr>
          </thead>
          <tbody>
            {% for s in sponsors %}
            <tr>
              <td class="ps-3"><strong>{{ s.name }}</strong></td>
              <td><span class="badge bg-primary">{{ s.count }}</span></td>
              <td class="pe-3">
                {% for d in s.drivers %}
                  <span class="badge bg-secondary me-1 mb-1">{{ d }}</span>
                {% endfor %}
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
    </div>
  </div>
  {% endif %}

  <!-- Failed Logins -->
  {% if failed_logins %}
  <div class="card shadow-sm border-0">
    <div class="card-header bg-white border-bottom py-3" style="cursor: pointer;" onclick="toggleSection('failed-logins-section')">
      <div class="d-flex justify-content-between align-items-center">
        <h5 class="mb-0 fw-bold">
          <i class="fas fa-exclamation-triangle text-warning me-2"></i>Recent Failed Login Attempts
          <i class="fas fa-chevron-down ms-2" id="failed-logins-chevron"></i>
        </h5>
      </div>
    </div>
    <div id="failed-logins-section">
    <div class="card-body p-0">
      <div class="scrollable-table-container">
        <table class="table table-hover mb-0 align-middle">
          <thead class="table-light">
            <tr>
              <th class="ps-3">Username</th>
              <th>IP Address</th>
              <th class="pe-3">Timestamp</th>
            </tr>
          </thead>
          <tbody>
            {% for attempt in failed_logins %}
            <tr>
              <td class="ps-3"><code>{{ attempt.username }}</code></td>
              <td><code>{{ attempt.ip_address }}</code></td>
              <td class="small pe-3">{{ attempt.timestamp|date:"Y-m-d H:i:s" }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
    </div>
  </div>
  {% endif %}
</div>

<script>
// Toggle section collapse/expand with localStorage persistence
function toggleSection(sectionId) {
  const section = document.getElementById(sectionId);
  const chevron = document.getElementById(sectionId.replace('-section', '-chevron'));
  
  if (!section || !chevron) return;
  
  if (section.style.display === 'none') {
    section.style.display = '';
    chevron.classList.remove('fa-chevron-right');
    chevron.classList.add('fa-chevron-down');
    localStorage.setItem(sectionId, 'expanded');
  } else {
    section.style.display = 'none';
    chevron.classList.remove('fa-chevron-down');
    chevron.classList.add('fa-chevron-right');
    localStorage.setItem(sectionId, 'collapsed');
  }
}

// Restore collapsed state from localStorage on page load
document.addEventListener('DOMContentLoaded', function() {
  const sections = ['drivers-section', 'sponsors-section', 'admins-section', 'legacy-sponsors-section', 'failed-logins-section'];
  
  sections.forEach(sectionId => {
    const savedState = localStorage.getItem(sectionId);
    if (savedState === 'collapsed') {
      const section = document.getElementById(sectionId);
      const chevron = document.getElementById(sectionId.replace('-section', '-chevron'));
      if (section && chevron) {
        section.style.display = 'none';
        chevron.classList.remove('fa-chevron-down');
        chevron.classList.add('fa-chevron-right');
      }
    }
  });
});

(function () {
  const els = document.querySelectorAll('.autocomplete');
  if (!els.length) return;

  function h(tag, cls, text){ const e=document.createElement(tag); if(cls) e.className=cls; if(text) e.textContent=text; return e; }

  els.forEach(wrapper => {
    const input = wrapper.querySelector('.ac-input') || wrapper.querySelector('input');
    const panel = wrapper.querySelector('.ac-panel');
    const endpoint = wrapper.dataset.endpoint;
    const limit = parseInt(wrapper.dataset.limit || "8", 10);

    let aborter = null, items = [], index = -1, lastQ = "";

    function clearPanel(){
      panel.innerHTML = "";
      panel.hidden = true;
      wrapper.classList.remove('open');
      items = []; index = -1;
    }

    function render(list){
      panel.innerHTML = "";
      list.slice(0, limit).forEach((row) => {
        const it = h('div', 'ac-item'); it.setAttribute('role','option');
        it.dataset.value = row.value || row.label || "";
        it.append(h('div','ac-label', row.label || row.value || ""));
        if (row.hint) it.append(h('div','ac-hint', row.hint));
        it.addEventListener('mousedown', (e)=>{ e.preventDefault(); commit(it.dataset.value); });
        panel.append(it);
      });
      panel.hidden = list.length === 0;
      if (!panel.hidden) wrapper.classList.add('open');
      items = Array.from(panel.children);
      index = items.length ? 0 : -1;
      highlight();
    }

    function highlight(){ items.forEach((el,i)=>el.setAttribute('aria-selected', i===index ? 'true':'false')); }
    function commit(val){ input.value = val; clearPanel(); }

    async function fetchData(q){
      if (!endpoint || !q) { clearPanel(); return; }
      try {
        if (aborter) aborter.abort();
        aborter = new AbortController();
        const res = await fetch(`${endpoint}?q=` + encodeURIComponent(q), {signal:aborter.signal});
        const data = await res.json();
        render(Array.isArray(data) ? data : []);
      } catch (_) {}
    }

    input.setAttribute('autocomplete','off');
    input.addEventListener('input', (e) => {
      const q = e.target.value.trim();
      if (q === lastQ) return; lastQ = q;
      if (!q) { clearPanel(); return; }
      fetchData(q);
    });

    input.addEventListener('keydown', (e) => {
      if (panel.hidden) return;
      if (e.key === 'ArrowDown'){ e.preventDefault(); index = Math.min(index+1, items.length-1); highlight(); }
      else if (e.key === 'ArrowUp'){ e.preventDefault(); index = Math.max(index-1, 0); highlight(); }
      else if (e.key === 'Enter'){ if (index>=0){ e.preventDefault(); commit(items[index].dataset.value); } }
      else if (e.key === 'Escape'){ clearPanel(); }
    });

    input.addEventListener('blur', () => setTimeout(clearPanel, 100));
  });
})();
</script>

<style>
.autocomplete {
  position: relative;
}
.ac-panel {
  position: absolute;
  top: 100%;
  left: 0;
  right: 0;
  background: white;
  border: 1px solid #dee2e6;
  border-radius: 0.375rem;
  box-shadow: 0 0.5rem 1rem rgba(0,0,0,0.15);
  z-index: 1000;
  max-height: 300px;
  overflow-y: auto;
  margin-top: 2px;
}
.ac-item {
  padding: 0.75rem 1rem;
  cursor: pointer;
  border-bottom: 1px solid #f0f0f0;
  transition: background-color 0.15s ease;
}
.ac-item:hover, .ac-item[aria-selected="true"] {
  background-color: #f8f9fa;
}
.ac-label {
  font-weight: 500;
  margin-bottom: 0.25rem;
}
.ac-hint {
  font-size: 0.875rem;
  color: #6c757d;
}
.dropdown {
  position: relative;
}
.dropdown-menu {
  min-width: 200px;
  position: absolute;
  right: 0;
  left: auto;
}
.dropdown-item {
  padding: 0.5rem 1rem;
  display: block;
  width: 100%;
  clear: both;
  font-weight: 400;
  color: #212529;
  text-align: inherit;
  text-decoration: none;
  white-space: nowrap;
  background-color: transparent;
  border: 0;
  cursor: pointer;
}
.dropdown-item:hover {
  background-color: #f8f9fa;
  color: #1e2125;
}
.dropdown-item.text-danger:hover {
  background-color: #f8d7da;
  color: #721c24;
}
.table th {
  font-weight: 600;
  font-size: 0.875rem;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  padding: 1rem 0.75rem;
}
.table td {
  padding: 1rem 0.75rem;
  vertical-align: middle;
}
.card-header {
  font-weight: 600;
  transition: background-color 0.2s ease;
}
.card-header[style*="cursor: pointer"]:hover {
  background-color: #f8f9fa !important;
}
#drivers-section,
#sponsors-section,
#admins-section,
#legacy-sponsors-section,
#failed-logins-section {
  transition: opacity 0.2s ease;
}

/* Scrollable table containers - show max 10 rows */
.scrollable-table-container {
  max-height: 600px; /* Approximately 10 rows */
  overflow-y: auto;
  overflow-x: auto;
}

.scrollable-table-container::-webkit-scrollbar {
  width: 8px;
  height: 8px;
}

.scrollable-table-container::-webkit-scrollbar-track {
  background: #f1f1f1;
  border-radius: 4px;
}

.scrollable-table-container::-webkit-scrollbar-thumb {
  background: #888;
  border-radius: 4px;
}

.scrollable-table-container::-webkit-scrollbar-thumb:hover {
  background: #555;
}

/* Make table header sticky when scrolling */
.scrollable-table-container thead th {
  position: sticky;
  top: 0;
  background-color: #f8f9fa;
  z-index: 10;
  box-shadow: 0 2px 2px -1px rgba(0, 0, 0, 0.1);
}

/* Simple Header Styling */
.header-section {
  background: white;
  border-radius: 8px;
  padding: 1.5rem;
  box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}

.page-title {
  font-size: 1.75rem;
  font-weight: 600;
  margin-bottom: 1rem;
  color: #333;
}

.action-bar {
  display: flex;
  gap: 0.75rem;
  flex-wrap: wrap;
  align-items: center;
}

.action-bar a,
.action-bar button {
  padding: 0.5rem 1rem;
  background: #f8f9fa;
  border: 1px solid #dee2e6;
  border-radius: 6px;
  color: #495057;
  text-decoration: none;
  font-size: 0.875rem;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.2s;
}

.action-bar a:hover,
.action-bar button:hover {
  background: #e9ecef;
  border-color: #adb5bd;
}

.action-bar form {
  display: flex;
  gap: 0.5rem;
  margin: 0;
}

.action-bar input[type="date"] {
  padding: 0.5rem;
  border: 1px solid #dee2e6;
  border-radius: 6px;
  font-size: 0.875rem;
}

/* Label Section Styling */
.label-section {
  background: white;
  border-radius: 8px;
  padding: 1.25rem 1.5rem;
  margin-bottom: 1.5rem;
  box-shadow: 0 1px 3px rgba(0,0,0,0.1);
  display: flex;
  justify-content: space-between;
  align-items: center;
  flex-wrap: wrap;
  gap: 1rem;
}

.label-filter-group {
  display: flex;
  align-items: center;
  gap: 1rem;
  flex-wrap: wrap;
}

.label-filter-group label {
  font-weight: 600;
  color: #333;
  font-size: 0.95rem;
  margin: 0;
}

.label-filter-group form {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  margin: 0;
}

.label-filter-group select {
  padding: 0.5rem 0.75rem;
  border: 1px solid #dee2e6;
  border-radius: 6px;
  background: #f8f9fa;
  color: #495057;
  font-size: 0.875rem;
  min-width: 200px;
  cursor: pointer;
}

.label-filter-group select:focus {
  outline: none;
  border-color: #adb5bd;
  background: white;
}

.label-filter-group .clear-btn {
  padding: 0.5rem 1rem;
  background: #dc3545;
  color: white;
  border: none;
  border-radius: 6px;
  text-decoration: none;
  font-size: 0.875rem;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.2s;
}

.label-filter-group .clear-btn:hover {
  background: #bb2d3b;
}

.label-actions {
  display: flex;
  gap: 0.5rem;
}

.label-actions a {
  padding: 0.5rem 1rem;
  background: #f8f9fa;
  border: 1px solid #dee2e6;
  border-radius: 6px;
  color: #495057;
  text-decoration: none;
  font-size: 0.875rem;
  font-weight: 500;
  transition: all 0.2s;
}

.label-actions a:hover {
  background: #e9ecef;
  border-color: #adb5bd;
}

/* Search section styling */
.search-grid {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 1.5rem;
  align-items: stretch;
}

.search-column {
  min-width: 0; /* Prevent overflow */
  display: flex;
  flex-direction: column;
}

.search-section {
  padding: 1.5rem;
  border-radius: 0.5rem;
  background-color: #f8f9fa;
  display: flex;
  flex-direction: column;
  flex: 1;
}

.search-title {
  font-weight: 600;
  font-size: 1rem;
  padding-bottom: 0.75rem;
  margin-bottom: 1rem;
  border-bottom: 2px solid #dee2e6;
  height: 40px; /* Fixed height for alignment */
  display: flex;
  align-items: center;
}

.search-section form {
  display: flex;
  flex-direction: column;
  flex: 1;
}

.search-section .form-control,
.search-section .ac-input {
  height: 42px;
  border: 2px solid #dee2e6;
  border-radius: 0.375rem;
  padding: 0.5rem 0.75rem;
  font-size: 0.95rem;
}

.search-section .autocomplete {
  margin-bottom: 1rem;
}

.search-section .btn {
  height: 42px;
  font-weight: 600;
  font-size: 0.95rem;
  margin-top: auto; /* Push button to bottom */
}

/* Responsive: stack on smaller screens */
@media (max-width: 991px) {
  .search-grid {
    grid-template-columns: 1fr;
  }
}
</style>
{% endblock content %}
