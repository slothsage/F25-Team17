{% extends "base.html" %}
{% load static %}
{% block content %}
<h1>Notification Settings</h1>

<form method="post" enctype="multipart/form-data">
  {% csrf_token %}
  {{ form.non_field_errors }}

  <fieldset style="margin-bottom:1rem">
    <legend>Kinds</legend>
    <label>{{ form.orders }} Orders</label><br>
    <label>{{ form.points }} Points</label><br>
    <label>{{ form.promotions }} Promotions</label>
  </fieldset>

    <fieldset style="margin-bottom:1rem">
    <legend>Channels</legend>
    <label>{{ form.email_enabled }} Email alerts</label><br>
    <label>{{ form.sms_enabled }} SMS alerts (preferred)</label>
    <p style="color:#666;margin:.35rem 0 0">
      If SMS is enabled, duplicate email alerts will be suppressed.
    </p>
  </fieldset>
  
    <fieldset style="margin-bottom:1rem">
    <legend>Theme</legend>
    <label for="{{ form.theme.id_for_label }}">Color theme</label><br>
    {{ form.theme }}
    {{ form.theme.errors }}
    <p style="color:#666;margin:.35rem 0 0">
      Pick light, dark, or high-contrast. Applies instantly.
    </p>
  </fieldset>

  <fieldset style="margin-bottom:1rem">
  <legend>Language</legend>
  <label for="{{ form.language.id_for_label }}">Preferred language</label><br>
  {{ form.language }}
  {{ form.language.errors }}
  <p style="color:#666;margin:.35rem 0 0">
    Choose your display language. Changes apply on next page load.
  </p>
</fieldset>

  <fieldset style="margin-bottom:1rem">
    <legend>Sound</legend>

    <div>
      <label for="{{ form.sound_mode.id_for_label }}">Mode</label><br>
      {{ form.sound_mode }}
      {{ form.sound_mode.errors }}
    </div>

    <div id="custom-file" style="margin-top:.5rem; {% if form.instance.sound_mode != 'custom' %}display:none{% endif %}">
      <label for="{{ form.sound_file.id_for_label }}">Custom audio (.mp3 / .wav / .ogg)</label><br>
      {{ form.sound_file }}
      {{ form.sound_file.errors }}
      {% if form.instance.sound_file %}
        <div style="margin-top:.25rem">
          Current file:
          <a href="{{ form.instance.sound_file.url }}" target="_blank" rel="noopener">Download</a>
        </div>
      {% endif %}
      <small style="color:#666;display:block;margin-top:.25rem">Tip: keep files short (&lt; 10s) for a snappy alert.</small>
    </div>

    <div style="margin-top:.75rem">
      <button type="button" class="btn" id="play-test" {% if not preview_url %}disabled{% endif %}>
        Play test sound
      </button>
      <audio id="test-audio" src="{{ preview_url }}" preload="none"></audio>
    </div>
  </fieldset>

  <button class="btn" type="submit">Save</button>
  <a class="btn" href="{% url 'accounts:notifications' %}" style="margin-left:.5rem">Back to Notifications</a>
</form>

<script>
  (function(){
    const mode = document.getElementById("id_sound_mode");
    const customWrap = document.getElementById("custom-file");
    const playBtn = document.getElementById("play-test");
    const audio = document.getElementById("test-audio");

    function refresh() {
      if (!mode) return;
      const isCustom = mode.value === "custom";
      if (customWrap) customWrap.style.display = isCustom ? "" : "none";
      // Enable/disable play button if preview exists
      if (playBtn) playBtn.disabled = !audio || !audio.src;
    }

    if (mode) {
      mode.addEventListener("change", refresh);
      refresh();
    }

    if (playBtn && audio) {
      playBtn.addEventListener("click", () => {
        if (!audio.src) return;
        try { audio.currentTime = 0; } catch(_) {}
        audio.play().catch(()=>{});
      });
    }
  })();
  (function () {
    const sel = document.getElementById("id_theme");
    if (!sel) return;

    // live-preview + persist
    sel.addEventListener("change", function () {
      const val = sel.value || "system";
      // Apply to <html>
      if (val === "system") {
        document.documentElement.removeAttribute("data-theme");
        document.documentElement.classList.remove("dark");
        // optional: auto-apply dark if OS prefers dark
        if (window.matchMedia("(prefers-color-scheme: dark)").matches) {
          document.documentElement.setAttribute("data-theme", "dark");
          document.documentElement.classList.add("dark");
        }
      } else {
        document.documentElement.setAttribute("data-theme", val);
        document.documentElement.classList.toggle("dark", val === "dark");
      }
      try { localStorage.setItem("theme", val); } catch (_) {}
    });
  })();
</script>
{% endblock %}